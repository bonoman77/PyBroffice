
{% extends "layout.html" %}
{% from "macros/form.html" import input, textarea %}
{% block title %}업체목록{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <div>
    <h1 class="page-title">업체목록</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">홈</a></li>
        <li class="breadcrumb-item">회원관리</li>
        <li class="breadcrumb-item active">업체목록</li>
      </ol>
    </nav>
  </div>
</div>

<!-- Client Stats Strip -->
<div class="users-stats">
  <div class="users-stat-card">
    <div class="users-stat-icon primary"><i class="ph-duotone ph-buildings"></i></div>
    <div class="users-stat-body">
      <div class="users-stat-value">{{ total_clients|default(0) }}</div>
      <div class="users-stat-label">전체 업체</div>
    </div>
  </div>
  <div class="users-stat-card">
    <div class="users-stat-icon success"><i class="ph-duotone ph-broom"></i></div>
    <div class="users-stat-body">
      <div class="users-stat-value">{{ cleaning_clients|default(0) }}</div>
      <div class="users-stat-label">청소</div>
    </div>
  </div>
  <div class="users-stat-card">
    <div class="users-stat-icon warning"><i class="ph-duotone ph-hamburger"></i></div>
    <div class="users-stat-body">
      <div class="users-stat-value">{{ snack_clients|default(0) }}</div>
      <div class="users-stat-label">간식</div>
    </div>
  </div>
  <div class="users-stat-card">
    <div class="users-stat-icon danger"><i class="ph-duotone ph-package"></i></div>
    <div class="users-stat-body">
      <div class="users-stat-value">{{ supplies_clients|default(0) }}</div>
      <div class="users-stat-label">비품</div>
    </div>
  </div>
</div>

<!-- Clients Table Card -->
<div class="card">
  <div class="users-toolbar">
    <div class="users-toolbar-left">
      <div class="users-search">
        <i class="ph ph-magnifying-glass"></i>
        <input type="text" placeholder="업체 검색..." id="clientSearch">
      </div>
      <div class="users-filter-group">
        <div class="dropdown">
          <button class="users-filter-btn" data-bs-toggle="dropdown">
            <i class="ph ph-funnel"></i> 업종
            <i class="ph ph-caret-down"></i>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item active" href="#" data-filter="type" data-value="all">전체 업종</a></li>
            <li><a class="dropdown-item" href="#" data-filter="type" data-value="cleaning">청소</a></li>
            <li><a class="dropdown-item" href="#" data-filter="type" data-value="snack">간식</a></li>
            <li><a class="dropdown-item" href="#" data-filter="type" data-value="office_supplies">비품</a></li>
          </ul>
        </div>
        <div class="dropdown">
          <button class="users-filter-btn" data-bs-toggle="dropdown">
            <i class="ph ph-circle-half"></i> 상태
            <i class="ph ph-caret-down"></i>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item active" href="#" data-filter="status" data-value="all">전체 상태</a></li>
            <li><a class="dropdown-item" href="#" data-filter="status" data-value="active">활성</a></li>
            <li><a class="dropdown-item" href="#" data-filter="status" data-value="inactive">비활성</a></li>
          </ul>
        </div>
      </div>
    </div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClientModal">
      <i class="ph ph-plus me-1"></i> 업체 등록
    </button>
  </div>

  <div class="users-table-wrap">
    <table class="users-table">
      <thead>
        <tr>
          <th class="users-th-check">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="selectAll">
            </div>
          </th>
          <th>업체명</th>
          <th>업무종류</th>
          <th>담당자</th>
          <th>상태</th>
          <th>계약일</th>
          <th class="users-th-actions">작업</th>
        </tr>
      </thead>
      <tbody>
        {% if clients %}
          {% for client in clients %}
          <tr>
            <td>
              <div class="form-check"><input class="form-check-input" type="checkbox"></div>
            </td>
            <td>
              <div class="users-cell-user">
                <div>
                  <div class="users-cell-name">{{ client.client_name }}</div>
                  <div class="users-cell-email">{{ client.client_business_number or '사업자번호 미등록' }}</div>
                </div>
              </div>
            </td>
            <td>
              {% set task_types = [] %}
              {% if client.cleaning_yn %}{% set _ = task_types.append('청소') %}{% endif %}
              {% if client.snack_yn %}{% set _ = task_types.append('간식') %}{% endif %}
              {% if client.office_supplies_yn %}{% set _ = task_types.append('비품') %}{% endif %}
              
              {% if task_types %}
                {% for task in task_types %}
                  {% if task == '청소' %}
                    <span class="users-role" style="background: #e0f2fe; color: #0369a1;"><i class="ph-fill ph-broom"></i> 청소</span>
                  {% elif task == '간식' %}
                    <span class="users-role" style="background: #fef3c7; color: #92400e;"><i class="ph-fill ph-hamburger"></i> 간식</span>
                  {% elif task == '비품' %}
                    <span class="users-role" style="background: #e0e7ff; color: #3730a3;"><i class="ph-fill ph-package"></i> 비품</span>
                  {% endif %}
                {% endfor %}
              {% else %}
                <span class="users-role user"><i class="ph-fill ph-briefcase"></i> 해당없음</span>
              {% endif %}
            </td>
            <td>
              {{ client.manager_name|default('-') }}
              <div class="users-cell-email">{{ client.manager_mobile or '연락처 없음' }}</div>
            </td>
            <td>
              {% if client.status == 'active' %}
              <span class="users-status active"><span class="users-status-dot"></span> 활성</span>
              {% else %}
              <span class="users-status inactive"><span class="users-status-dot"></span> 비활성</span>
              {% endif %}
            </td>
            <td class="users-cell-meta">{{ client.contract_date|default('미정') }}</td>
            <td>
              <div class="users-actions">
                <!-- <a href="/clients/view/{{ client.client_id }}" class="users-action-btn" title="보기"><i class="ph ph-eye"></i></a> -->
                <button class="users-action-btn edit-client-btn" title="수정"
                        data-client-id="{{ client.client_id }}"
                        data-client-name="{{ client.client_name }}"
                        data-client-phone="{{ client.client_phone }}"
                        data-client-address="{{ client.client_address }}"
                        data-client-business-number="{{ client.client_business_number }}"
                        data-manager-name="{{ client.manager_name }}"
                        data-manager-mobile="{{ client.manager_mobile }}"
                        data-manager-position="{{ client.manager_position }}"
                        data-contract-date="{{ client.contract_date|default('') }}"
                        data-memo="{{ client.memo|default('') }}"
                        data-cleaning-yn="{{ client.cleaning_yn }}"
                        data-snack-yn="{{ client.snack_yn }}"
                        data-office-supplies-yn="{{ client.office_supplies_yn }}"
                        data-status="{{ client.status }}">
                  <i class="ph ph-pencil-simple"></i>
                </button>
                <button class="users-action-btn danger" title="삭제" data-client-id="{{ client.client_id }}" data-client-name="{{ client.client_name }}" onclick="showDeleteClientModal(this)"><i class="ph ph-trash"></i></button>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="8" class="text-center py-5">
              <div class="text-muted">
                <i class="ph ph-buildings" style="font-size: 48px; opacity: 0.3;"></i>
                <p class="mt-3 mb-0">등록된 업체가 없습니다.</p>
              </div>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="users-pagination" id="clientsPagination" style="display: none;">
    <div class="users-pagination-info" id="paginationInfo">
      Showing <strong id="showingRange">1-10</strong> of <strong id="totalCount">0</strong> clients
    </div>
    <nav>
      <ul class="pagination mb-0" id="paginationList">
        <!-- 페이지 버튼이 동적으로 생성됩니다 -->
      </ul>
    </nav>
  </div>
</div>

<!-- Add Client Modal -->
<div class="modal fade" id="addClientModal" tabindex="-1" aria-labelledby="addClientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addClientModalLabel">업체 등록</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addClientForm" action="{{ url_for('accounts.client_insert_post') }}" method="post">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="clientName" class="form-label">업체명 <span class="text-danger">*</span></label>
              {{ input('text', 'clientName', '', opt='required') }}
            </div>
            <div class="col-md-6 mb-3">
              <label for="clientBusinessNumber" class="form-label">사업자등록번호</label>
              {{ input('text', 'clientBusinessNumber', '', placeholder='000-00-00000') }}
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="clientPhone" class="form-label">업체 연락처 <span class="text-danger">*</span></label>
              {{ input('tel', 'clientPhone', '', opt='required') }}
            </div>
            <div class="col-md-6 mb-3">
              <label for="contractDate" class="form-label">계약일 <span class="text-danger">*</span></label>
              {{ input('date', 'contractDate', '', opt='required') }}
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="managerName" class="form-label">담당자명</label>
              {{ input('text', 'managerName', '') }}
            </div>
            <div class="col-md-4 mb-3">
              <label for="managerPosition" class="form-label">담당자 직급</label>
              {{ input('text', 'managerPosition', '', placeholder='예: 과장, 팀장') }}
            </div>
            <div class="col-md-4 mb-3">
              <label for="managerMobile" class="form-label">담당자 연락처</label>
              {{ input('tel', 'managerMobile', '', placeholder='010-0000-0000') }}
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="status" class="form-label">상태</label>
              <select class="form-select" id="status" name="status">
                <option value="active" selected>활성</option>
                <option value="inactive">비활성</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">업무 종류 <span class="text-danger">*</span></label>
              <div class="d-flex gap-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="cleaningYn" name="cleaningYn">
                  <label class="form-check-label" for="cleaningYn">청소</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="snackYn" name="snackYn">
                  <label class="form-check-label" for="snackYn">스낵</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="officeSuppliesYn" name="officeSuppliesYn">
                  <label class="form-check-label" for="officeSuppliesYn">비품</label>
                </div>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="clientAddress" class="form-label">주소</label>
            {{ input('text', 'clientAddress', '') }}
          </div>
          <div class="mb-3">
            <label for="memo" class="form-label">비고</label>
            {{ textarea('memo', '', rows='3') }}
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" onclick="submitAddClient()">등록</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Client Modal -->
<div class="modal fade" id="deleteClientModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center py-4">
        <div class="mb-3">
          <span class="bg-danger-subtle text-danger rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
            <i class="bi bi-exclamation-triangle fs-1"></i>
          </span>
        </div>
        <h5>업체 삭제</h5>
        <p class="text-muted mb-2">정말로 <strong id="deleteClientName"></strong> 업체를 삭제하시겠습니까?</p>
        <p class="text-muted mb-0 small">이 작업은 되돌릴 수 없습니다.</p>
        <input type="hidden" id="deleteClientId">
      </div>
      <div class="modal-footer justify-content-center border-0 pt-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-danger" onclick="confirmDeleteClient()">삭제</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Client Modal -->
<div class="modal fade" id="editClientModal" tabindex="-1" aria-labelledby="editClientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editClientModalLabel">업체 수정</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editClientForm" action="{{ url_for('accounts.client_update_post') }}" method="post">
          <input type="hidden" id="editClientId" name="clientId">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editClientName" class="form-label">업체명 <span class="text-danger">*</span></label>
              {{ input('text', 'editClientName', '', opt='required') }}
            </div>
            <div class="col-md-6 mb-3">
              <label for="editClientBusinessNumber" class="form-label">사업자등록번호</label>
              {{ input('text', 'editClientBusinessNumber', '', placeholder='000-00-00000') }}
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editClientPhone" class="form-label">업체 연락처 <span class="text-danger">*</span></label>
              {{ input('tel', 'editClientPhone', '', opt='required') }}
            </div>
            <div class="col-md-6 mb-3">
              <label for="editContractDate" class="form-label">계약일 <span class="text-danger">*</span></label>
              {{ input('date', 'editContractDate', '', opt='required') }}
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="editManagerName" class="form-label">담당자명</label>
              {{ input('text', 'editManagerName', '') }}
            </div>
            <div class="col-md-4 mb-3">
              <label for="editManagerPosition" class="form-label">담당자 직급</label>
              {{ input('text', 'editManagerPosition', '', placeholder='예: 과장, 팀장') }}
            </div>
            <div class="col-md-4 mb-3">
              <label for="editManagerMobile" class="form-label">담당자 연락처</label>
              {{ input('tel', 'editManagerMobile', '', placeholder='010-0000-0000') }}
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editStatus" class="form-label">상태</label>
              <select class="form-select" id="editStatus" name="editStatus">
                <option value="active">활성</option>
                <option value="inactive">비활성</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">업무 종류 <span class="text-danger">*</span></label>
              <div class="d-flex gap-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="editCleaningYn" name="editCleaningYn">
                  <label class="form-check-label" for="editCleaningYn">청소</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="editSnackYn" name="editSnackYn">
                  <label class="form-check-label" for="editSnackYn">스낵</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="editOfficeSuppliesYn" name="editOfficeSuppliesYn">
                  <label class="form-check-label" for="editOfficeSuppliesYn">비품</label>
                </div>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="editClientAddress" class="form-label">주소</label>
            {{ input('text', 'editClientAddress', '') }}
          </div>
          <div class="mb-3">
            <label for="editMemo" class="form-label">비고</label>
            {{ textarea('editMemo', '', rows='3') }}
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" onclick="submitEditClient()">수정</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// 페이징 인스턴스 생성
const clientPagination = new TablePagination({
  tableSelector: '.users-table tbody',
  paginationSelector: '#clientsPagination',
  itemsPerPage: 10
});

// 커스텀 필터 함수 정의
clientPagination.customFilter = function(row, filters) {
  console.log('customFilter called:', filters);
  
  // 업종 필터 - 복수 선택 지원
  if (filters.type && filters.type !== 'all') {
    const typeElements = row.querySelectorAll('.users-role');
    console.log('Type elements found:', typeElements.length);
    if (typeElements.length > 0) {
      const typeTexts = Array.from(typeElements).map(el => el.textContent);
      console.log('Type texts:', typeTexts);
      const filterMap = {
        'cleaning': '청소',
        'snack': '간식',
        'office_supplies': '비품'
      };
      
      // 쾔마로 구분된 필터 값 분할 (예: "cleaning,snack")
      const filterTypes = filters.type.split(',');
      console.log('Filter types:', filterTypes);
      
      // 선택한 업종 중 하나라도 포함되어 있는지 확인
      const hasMatch = filterTypes.some(filterType => {
        const targetText = filterMap[filterType.trim()];
        return targetText && typeTexts.some(text => text.includes(targetText));
      });
      
      console.log('Has match:', hasMatch);
      if (!hasMatch) return false;
    }
  }
  
  // 상태 필터
  if (filters.status && filters.status !== 'all') {
    const statusElement = row.querySelector('.users-status');
    console.log('Status element:', statusElement);
    if (statusElement) {
      const hasClass = statusElement.classList.contains(filters.status);
      console.log('Status filter:', filters.status, 'has class:', hasClass);
      if (!hasClass) return false;
    }
  }
  
  return true;
};

// Select All Checkbox
document.getElementById('selectAll')?.addEventListener('change', function() {
  const checkboxes = document.querySelectorAll('.users-table tbody input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = this.checked);
});

// 검색 기능
document.getElementById('clientSearch')?.addEventListener('input', function(e) {
  const searchValue = e.target.value;
  console.log('Search input event fired! Value:', searchValue);
  console.log('clientPagination exists:', !!clientPagination);
  console.log('clientPagination.applySearchFilter exists:', !!clientPagination.applySearchFilter);
  clientPagination.applySearchFilter(searchValue, ['.users-cell-name']);
});

// 필터 기능
document.querySelectorAll('[data-filter]').forEach(item => {
  item.addEventListener('click', function(e) {
    e.preventDefault();
    const filterType = this.dataset.filter;
    const filterValue = this.dataset.value;
    
    console.log('Filter clicked:', filterType, filterValue);
    
    // 활성 상태 업데이트
    this.closest('.dropdown-menu').querySelectorAll('.dropdown-item').forEach(i => {
      i.classList.remove('active');
    });
    this.classList.add('active');
    
    // 필터 적용
    console.log('Calling setFilter with:', filterType, filterValue);
    clientPagination.setFilter(filterType, filterValue);
  });
});

// Add Client Form Submit
function submitAddClient() {
  const form = document.getElementById('addClientForm');
  
  if (form.checkValidity()) {
    form.submit();
  } else {
    form.reportValidity();
  }
}

// Edit Client - Load data into modal
document.querySelectorAll('.edit-client-btn').forEach(button => {
  button.addEventListener('click', function() {
    const clientId = this.dataset.clientId;
    const clientName = this.dataset.clientName;
    const clientPhone = this.dataset.clientPhone;
    const clientAddress = this.dataset.clientAddress;
    const clientBusinessNumber = this.dataset.clientBusinessNumber;
    const managerName = this.dataset.managerName;
    const managerMobile = this.dataset.managerMobile;
    const managerPosition = this.dataset.managerPosition;
    const contractDate = this.dataset.contractDate;
    const memo = this.dataset.memo;
    const cleaningYn = this.dataset.cleaningYn;
    const snackYn = this.dataset.snackYn;
    const officeSuppliesYn = this.dataset.officeSuppliesYn;
    const status = this.dataset.status;
    
    // Populate form fields
    document.getElementById('editClientId').value = clientId;
    document.getElementById('editClientName').value = clientName;
    document.getElementById('editClientPhone').value = clientPhone;
    document.getElementById('editClientAddress').value = clientAddress;
    document.getElementById('editClientBusinessNumber').value = clientBusinessNumber;
    document.getElementById('editManagerName').value = managerName;
    document.getElementById('editManagerMobile').value = managerMobile;
    document.getElementById('editManagerPosition').value = managerPosition;
    document.getElementById('editContractDate').value = contractDate;
    document.getElementById('editMemo').value = memo;
    
    // Set task kind checkboxes
    document.getElementById('editCleaningYn').checked = cleaningYn == 1;
    document.getElementById('editSnackYn').checked = snackYn == 1;
    document.getElementById('editOfficeSuppliesYn').checked = officeSuppliesYn == 1;
    
    // Set status select
    document.getElementById('editStatus').value = status;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editClientModal'));
    modal.show();
  });
});

// Edit Client Form Submit
function submitEditClient() {
  const form = document.getElementById('editClientForm');
  
  if (form.checkValidity()) {
    form.submit();
  } else {
    form.reportValidity();
  }
}

// Delete Client - Show confirmation modal
function showDeleteClientModal(button) {
  const clientId = button.dataset.clientId;
  const clientName = button.dataset.clientName;
  
  document.getElementById('deleteClientId').value = clientId;
  document.getElementById('deleteClientName').textContent = clientName;
  
  const modal = new bootstrap.Modal(document.getElementById('deleteClientModal'));
  modal.show();
}

// Delete Client - Confirm deletion
function confirmDeleteClient() {
  const clientId = document.getElementById('deleteClientId').value;
  
  // AJAX 요청으로 업체 삭제
  fetch("{{ url_for('accounts.client_admin_delete_post') }}", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: JSON.stringify({ client_id: clientId })
  })
  .then(response => response.json())
  .then(data => {
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteClientModal'));
    modal.hide();
    
    if (data.success) {
      showToast('success', data.message || '업체가 삭제되었습니다.');
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast('danger', data.error || '업체 삭제에 실패했습니다.');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('danger', '업체 삭제 중 오류가 발생했습니다.');
  });
}

// Toast 알림 함수
function showToast(type, message) {
  const toastContainer = document.getElementById('toastContainer') || createToastContainer();
  const toastId = 'toast-' + Date.now();
  
  const toastHtml = `
    <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `;
  
  toastContainer.insertAdjacentHTML('beforeend', toastHtml);
  const toastElement = document.getElementById(toastId);
  const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
  toast.show();
  
  toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
}

function createToastContainer() {
  const container = document.createElement('div');
  container.id = 'toastContainer';
  container.className = 'toast-container position-fixed top-0 end-0 p-3';
  container.style.zIndex = '1050';
  document.body.appendChild(container);
  return container;
}

// Old delete function (deprecated)
function deleteClient(clientId) {
  // Deprecated: use showDeleteClientModal instead
}
</script>
{% endblock %}
