{% extends "layout.html" %}
{% from "macros/form.html" import input, password_toggle %}
{% block title %}회원목록{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <div>
    <h1 class="page-title">회원목록</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">홈</a></li>
        <li class="breadcrumb-item">회원관리</li>
        <li class="breadcrumb-item active">회원목록</li>
      </ol>
    </nav>
  </div>
</div>

<!-- User Stats Strip -->
<div class="users-stats">
  <div class="users-stat-card">
    <div class="users-stat-icon primary"><i class="ph-duotone ph-users-three"></i></div>
    <div class="users-stat-body">
      <div class="users-stat-value">{{ total_users|default(0) }}</div>
      <div class="users-stat-label">전체 회원</div>
    </div>
  </div>
  <div class="users-stat-card">
    <div class="users-stat-icon success"><i class="ph-duotone ph-user-check"></i></div>
    <div class="users-stat-body">
      <div class="users-stat-value">{{ active_users|default(0) }}</div>
      <div class="users-stat-label">활성</div>
    </div>
  </div>
  <div class="users-stat-card">
    <div class="users-stat-icon warning"><i class="ph-duotone ph-clock-countdown"></i></div>
    <div class="users-stat-body">
      <div class="users-stat-value">{{ pending_users|default(0) }}</div>
      <div class="users-stat-label">대기</div>
    </div>
  </div>
  <div class="users-stat-card">
    <div class="users-stat-icon danger"><i class="ph-duotone ph-user-minus"></i></div>
    <div class="users-stat-body">
      <div class="users-stat-value">{{ inactive_users|default(0) }}</div>
      <div class="users-stat-label">비활성</div>
    </div>
  </div>
</div>

<!-- Users Table Card -->
<div class="card">
  <div class="users-toolbar">
    <div class="users-toolbar-left">
      <div class="users-search">
        <i class="ph ph-magnifying-glass"></i>
        <input type="text" placeholder="회원 검색..." id="userSearch">
      </div>
      <div class="users-filter-group">
        <div class="dropdown">
          <button class="users-filter-btn" data-bs-toggle="dropdown">
            <i class="ph ph-funnel"></i> 역할
            <i class="ph ph-caret-down"></i>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item active" href="#" data-filter="role" data-value="all">전체 역할</a></li>
            <li><a class="dropdown-item" href="#" data-filter="role" data-value="admin">관리자</a></li>
            <li><a class="dropdown-item" href="#" data-filter="role" data-value="staff">현장직원</a></li>
            <li><a class="dropdown-item" href="#" data-filter="role" data-value="company">업체담당자</a></li>
          </ul>
        </div>
        <div class="dropdown">
          <button class="users-filter-btn" data-bs-toggle="dropdown">
            <i class="ph ph-circle-half"></i> 상태
            <i class="ph ph-caret-down"></i>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item active" href="#" data-filter="status" data-value="all">전체 상태</a></li>
            <li><a class="dropdown-item" href="#" data-filter="status" data-value="active">활성</a></li>
            <li><a class="dropdown-item" href="#" data-filter="status" data-value="pending">대기</a></li>
            <li><a class="dropdown-item" href="#" data-filter="status" data-value="inactive">비활성</a></li>
          </ul>
        </div>
      </div>
    </div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
      <i class="ph ph-plus me-1"></i> 회원 추가
    </button>
  </div>

  <div class="users-table-wrap">
    <table class="users-table">
      <thead>
        <tr>
          <th class="users-th-check">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="selectAll">
            </div>
          </th>
          <th>회원</th>
          <th>역할</th>
          <th>상태</th>
          <th>최근 활동</th>
          <th>가입일</th>
          <th class="users-th-actions">작업</th>
        </tr>
      </thead>
      <tbody>
        {% if users %}
          {% for user in users %}
          <tr>
            <td>
              <div class="form-check"><input class="form-check-input" type="checkbox"></div>
            </td>
            <td>
              <div class="users-cell-user">
                <div>
                  <a href="/members/view/{{ user.id }}" class="users-cell-name">{{ user.name }}</a>
                  <div class="users-cell-email">{{ user.email }}</div>
                </div>
              </div>
            </td>
            <td>
              {% if user.role == 'admin' %}
              <span class="users-role admin"><i class="ph-fill ph-shield-chevron"></i> 관리자</span>
              {% elif user.role == 'staff' %}
              <span class="users-role manager"><i class="ph-fill ph-identification-badge"></i> 현장직원</span>
              {% elif user.role == 'client' %}
              <span class="users-role user"><i class="ph-fill ph-briefcase"></i> 업체담당자</span>
              {% else %}
              <span class="users-role user"><i class="ph-fill ph-user"></i> 일반</span>
              {% endif %}
            </td>
            <td>
              {% if user.status == 'active' %}
              <span class="users-status active"><span class="users-status-dot"></span> 활성</span>
              {% elif user.status == 'pending' %}
              <span class="users-status pending"><span class="users-status-dot"></span> 대기</span>
              {% else %}
              <span class="users-status inactive"><span class="users-status-dot"></span> 비활성</span>
              {% endif %}
            </td>
            <td class="users-cell-meta">{{ user.last_active|default('알 수 없음') }}</td>
            <td class="users-cell-meta">{{ user.joined_date|default('알 수 없음') }}</td>
            <td>
              <div class="users-actions">
                <a href="/members/view/{{ user.id }}" class="users-action-btn" title="보기"><i class="ph ph-eye"></i></a>
                <a href="/members/edit/{{ user.id }}" class="users-action-btn" title="수정"><i class="ph ph-pencil-simple"></i></a>
                <button class="users-action-btn danger" title="삭제" onclick="deleteUser({{ user.id }})"><i class="ph ph-trash"></i></button>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="7" class="text-center py-5">
              <div class="text-muted">
                <i class="ph ph-users-three" style="font-size: 48px; opacity: 0.3;"></i>
                <p class="mt-3 mb-0">등록된 회원이 없습니다.</p>
              </div>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if users and users|length > 0 %}
  <div class="users-pagination">
    <div class="users-pagination-info">
      Showing <strong>1-{{ users|length }}</strong> of <strong>{{ total_users|default(users|length) }}</strong> users
    </div>
    <nav>
      <ul class="pagination mb-0">
        <li class="page-item disabled">
          <a class="page-link" href="#"><i class="ph ph-caret-left"></i></a>
        </li>
        <li class="page-item active"><a class="page-link" href="#">1</a></li>
        <li class="page-item"><a class="page-link" href="#">2</a></li>
        <li class="page-item"><a class="page-link" href="#">3</a></li>
        <li class="page-item">
          <a class="page-link" href="#"><i class="ph ph-caret-right"></i></a>
        </li>
      </ul>
    </nav>
  </div>
  {% endif %}
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addUserModalLabel">회원 추가</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning" role="alert">
          
          <strong>주의:</strong> 관리자가 직접 등록하는 회원은 이용약관 및 개인정보처리방침 동의 절차 없이 가입됩니다.
        </div>
        <form id="addUserForm" action="{{ url_for('accounts.user_insert_post') }}" method="post">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="userName" class="form-label">이름 <span class="text-danger">*</span></label>
              {{ input('text', 'userName', '', opt='required') }}
            </div>
            <div class="col-md-6 mb-3">
              <label for="userAccount" class="form-label">아이디 <span class="text-danger">*</span></label>
              {{ input('text', 'userAccount', '', opt='required') }}
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="userEmail" class="form-label">이메일</label>
              {{ input('email', 'userEmail', '') }}
            </div>
            <div class="col-md-6 mb-3">
              <label for="userPhone" class="form-label">연락처 <span class="text-danger">*</span></label>
              {{ input('tel', 'userPhone', '', placeholder='010-0000-0000', opt='required') }}
            </div>
          </div>
          <div class="mb-3">
            <label for="userRole" class="form-label">역할 <span class="text-danger">*</span></label>
            <select class="form-select" id="userRole" name="userRole" required>
              <option value="">선택하세요</option>
              <option value="1">관리자</option>
              <option value="2">본사 직원</option>
              <option value="3">의뢰 업체</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="userPassword" class="form-label">비밀번호 <span class="text-danger">*</span></label>
            {{ password_toggle('userPassword', '', placeholder='비밀번호를 입력하세요', min='8', opt='required') }}
            <div class="form-text">최소 8자 이상 입력해주세요.</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" onclick="submitAddUser()">추가</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editUserModalLabel">회원 정보 수정</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editUserForm" action="{{ url_for('accounts.user_admin_update_post') }}" method="post">
          <input type="hidden" id="editUserId" name="userId">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editUserName" class="form-label">이름 <span class="text-danger">*</span></label>
              {{ input('text', 'editUserName', '', opt='required') }}
            </div>
            <div class="col-md-6 mb-3">
              <label for="editUserAccount" class="form-label">아이디 <span class="text-danger">*</span></label>
              {{ input('text', 'editUserAccount', '', opt='required disabled') }}
              <div class="form-text">아이디는 변경할 수 없습니다.</div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editUserEmail" class="form-label">이메일</label>
              {{ input('email', 'editUserEmail', '') }}
            </div>
            <div class="col-md-6 mb-3">
              <label for="editUserPhone" class="form-label">연락처 <span class="text-danger">*</span></label>
              {{ input('tel', 'editUserPhone', '', placeholder='010-0000-0000', opt='required') }}
            </div>
          </div>
          <div class="mb-3">
            <label for="editUserRole" class="form-label">역할 <span class="text-danger">*</span></label>
            <select class="form-select" id="editUserRole" name="editUserRole" required>
              <option value="">선택하세요</option>
              <option value="1">관리자</option>
              <option value="2">본사 직원</option>
              <option value="3">의뢰 업체</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editUserPassword" class="form-label">비밀번호</label>
            {{ password_toggle('editUserPassword', '', placeholder='변경하지 않으려면 비워두세요', min='8') }}
            <div class="form-text">비밀번호를 변경하려면 입력하세요 (최소 8자). 비워두면 기존 비밀번호 유지됩니다.</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" onclick="submitEditUser()">수정</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Select All Checkbox
document.getElementById('selectAll')?.addEventListener('change', function() {
  const checkboxes = document.querySelectorAll('.users-table tbody input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = this.checked);
});

// Search Functionality
document.getElementById('userSearch')?.addEventListener('input', function(e) {
  const searchTerm = e.target.value.toLowerCase();
  const rows = document.querySelectorAll('.users-table tbody tr');
  
  rows.forEach(row => {
    const name = row.querySelector('.users-cell-name')?.textContent.toLowerCase() || '';
    const email = row.querySelector('.users-cell-email')?.textContent.toLowerCase() || '';
    
    if (name.includes(searchTerm) || email.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
});

// Filter Functionality
document.querySelectorAll('[data-filter]').forEach(item => {
  item.addEventListener('click', function(e) {
    e.preventDefault();
    const filterType = this.dataset.filter;
    const filterValue = this.dataset.value;
    
    // Update active state
    this.closest('.dropdown-menu').querySelectorAll('.dropdown-item').forEach(i => {
      i.classList.remove('active');
    });
    this.classList.add('active');
    
    // Apply filter
    const rows = document.querySelectorAll('.users-table tbody tr');
    rows.forEach(row => {
      if (filterValue === 'all') {
        row.style.display = '';
      } else {
        const cellText = row.querySelector(filterType === 'role' ? '.users-role' : '.users-status')?.textContent.toLowerCase() || '';
        if (cellText.includes(filterValue)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      }
    });
  });
});

// Add User Form Submit
function submitAddUser() {
  const form = document.getElementById('addUserForm');
  if (form.checkValidity()) {
    form.submit();
  } else {
    form.reportValidity();
  }
}

// Edit User - Load data into modal
function editUser(userId, userData) {
  // Populate form fields
  document.getElementById('editUserId').value = userId;
  document.getElementById('editUserName').value = userData.name || '';
  document.getElementById('editUserAccount').value = userData.account || '';
  document.getElementById('editUserEmail').value = userData.email || '';
  document.getElementById('editUserPhone').value = userData.phone || '';
  document.getElementById('editUserRole').value = userData.role || '';
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
  modal.show();
}

// Edit User Form Submit
function submitEditUser() {
  const form = document.getElementById('editUserForm');
  if (form.checkValidity()) {
    form.submit();
  } else {
    form.reportValidity();
  }
}

// Delete User
function deleteUser(userId) {
  if (confirm('정말로 이 회원을 삭제하시겠습니까?')) {
    // TODO: Send AJAX request to delete user
    console.log('Deleting user:', userId);
    alert('회원이 삭제되었습니다.');
    location.reload();
  }
}

// Password Toggle for Edit Modal
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('[data-toggle-password]').forEach(button => {
    button.addEventListener('click', function() {
      const input = this.parentElement.querySelector('input');
      const icon = this.querySelector('i');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('ph-eye');
        icon.classList.add('ph-eye-slash');
      } else {
        input.type = 'password';
        icon.classList.remove('ph-eye-slash');
        icon.classList.add('ph-eye');
      }
    });
  });
});
</script>
{% endblock %}
