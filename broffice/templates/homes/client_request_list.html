{% extends "layout.html" %}
{% set user_kind = session.get('login_user', {}).get('user_kind_id', 0) %}
{% set page_title = '요청사항' if user_kind == 3 else '업체 요청사항' %}
{% set can_edit = (user_kind == 3) %}
{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <div>
    <h1 class="page-title">{{ page_title }}</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">홈</a></li>
        <li class="breadcrumb-item active">{{ page_title }}</li>
      </ol>
    </nav>
  </div>
</div>

<div class="card">
  <div class="card-header d-flex align-items-center justify-content-between">
    <div>
      <h5 class="mb-1">{{ page_title }} 목록</h5>
    </div>
    {% if can_edit %}
    <button class="btn btn-primary" onclick="openModal()">
      <i class="ph ph-plus me-1"></i> 요청 등록
    </button>
    {% endif %}
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead>
          <tr>
            <th>제목</th>
            {% if user_kind == 1 %}
            <th style="width: 120px;">업체명</th>
            {% endif %}
            <th style="width: 100px;">작성자</th>
            {% if user_kind == 1 %}
            <th style="width: 80px;">확인</th>
            {% endif %}
            <th style="width: 130px;">등록일</th>
          </tr>
        </thead>
        <tbody>
          {% if res_list %}
            {% for res in res_list %}
            <tr style="cursor: pointer;" onclick="{% if can_edit %}openModal({{ res.request_id }}){% else %}openDetailModal({{ res.request_id }}){% endif %}">
              <td class="text-truncate" style="max-width: 400px;">{{ res.Title[:30] }}{% if res.Title|length > 30 %}...{% endif %}</td>
              {% if user_kind == 1 %}
              <td><span class="badge bg-light text-dark">{{ res.ClientName or '-' }}</span></td>
              {% endif %}
              <td>{{ res.UserName }}</td>
              {% if user_kind == 1 %}
              <td class="text-center">
                {% if res.AdminCheckedAt %}
                <span class="badge badge-soft-success">확인</span>
                {% else %}
                <span class="badge badge-soft-warning">미확인</span>
                {% endif %}
              </td>
              {% endif %}
              <td class="text-muted small">{{ res.CreateDate[:10] if res.CreateDate else '-' }}</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="6" class="text-center py-5">
                <div class="text-muted">
                  <i class="bi bi-inbox" style="font-size: 48px; opacity: 0.3;"></i>
                  <p class="mt-3 mb-0">등록된 {{ page_title }}이 없습니다.</p>
                </div>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
  {% if total_pages > 1 %}
  <div class="card-footer d-flex align-items-center justify-content-between">
    <span class="text-muted small">전체 {{ total_count }}건</span>
    <nav>
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item {{ 'disabled' if page <= 1 }}">
          <a class="page-link" href="{{ url_for('homes.client_request_list', page=page-1) }}"><i class="ph ph-caret-left"></i></a>
        </li>
        {% for p in range(1, total_pages + 1) %}
        <li class="page-item {{ 'active' if p == page }}">
          <a class="page-link" href="{{ url_for('homes.client_request_list', page=p) }}">{{ p }}</a>
        </li>
        {% endfor %}
        <li class="page-item {{ 'disabled' if page >= total_pages }}">
          <a class="page-link" href="{{ url_for('homes.client_request_list', page=page+1) }}"><i class="ph ph-caret-right"></i></a>
        </li>
      </ul>
    </nav>
  </div>
  {% elif total_count > 0 %}
  <div class="card-footer">
    <span class="text-muted small">전체 {{ total_count }}건</span>
  </div>
  {% endif %}
</div>

<!-- 등록/수정 모달 -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">요청 등록</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editForm">
          <input type="hidden" id="itemId" name="requestId">
          <div class="mb-3">
            <label for="itemTitle" class="form-label">제목 <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="itemTitle" name="title" placeholder="제목을 입력하세요" required>
          </div>
          <div class="mb-3">
            <label for="itemContent" class="form-label">내용</label>
            <textarea class="form-control" id="itemContent" name="content" rows="6" placeholder="내용을 입력하세요"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger me-auto" id="btnDelete" style="display:none;" onclick="deleteItem()">
          <i class="ph ph-trash me-1"></i>삭제
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" id="btnSave" onclick="saveItem()">등록</button>
      </div>
    </div>
  </div>
</div>

<!-- 관리자용 상세 모달 (확인/삭제만) -->
{% if not can_edit %}
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">요청사항 상세</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="detailRequestId">
        <div class="mb-3">
          <label class="form-label fw-semibold">제목</label>
          <div id="detailTitle" class="form-control-plaintext"></div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-semibold">내용</label>
          <div id="detailContent" class="form-control-plaintext border rounded p-2" style="min-height: 100px; white-space: pre-wrap;"></div>
        </div>
        <div class="d-flex justify-content-between">
          <div>
            <span class="text-muted small">업체: <strong id="detailClientName"></strong></span>
          </div>
          <div>
            <span class="text-muted small">등록일: <span id="detailCreateDate"></span></span>
          </div>
        </div>
        <div class="mt-2 text-end">
          <span id="detailCheckBadge"></span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger me-auto" onclick="deleteFromDetail()">
          <i class="ph ph-trash me-1"></i>삭제
        </button>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
        <button type="button" class="btn btn-success" id="detailBtnCheck" onclick="checkFromDetail()">
          <i class="ph ph-check me-1"></i>확인처리
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
function openModal(itemId) {
    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    const form = document.getElementById('editForm');
    form.reset();
    document.getElementById('itemId').value = '';
    document.getElementById('btnDelete').style.display = 'none';
    document.getElementById('editModalLabel').textContent = '요청 등록';
    const btnSave = document.getElementById('btnSave');
    btnSave.textContent = '등록';
    btnSave.className = 'btn btn-primary';
    
    if (itemId) {
        document.getElementById('editModalLabel').textContent = '요청 수정';
        document.getElementById('btnDelete').style.display = 'block';
        btnSave.textContent = '수정';
        btnSave.className = 'btn btn-success';
        
        fetch('/get_client_request_content?request_id=' + itemId)
            .then(r => r.json())
            .then(data => {
                if (data.success && data.data) {
                    const d = data.data;
                    document.getElementById('itemId').value = d.request_id;
                    document.getElementById('itemTitle').value = d.title || '';
                    document.getElementById('itemContent').value = d.content || '';
                }
            });
    }
    modal.show();
}

function saveItem() {
    const itemId = document.getElementById('itemId').value;
    const title = document.getElementById('itemTitle').value.trim();
    if (!title) {
        document.getElementById('itemTitle').focus();
        return;
    }
    
    const formData = new FormData(document.getElementById('editForm'));
    const url = itemId ? '/client_request_update' : '/client_request_list';
    
    fetch(url, { method: 'POST', body: formData })
        .then(r => {
            if (itemId) return r.json();
            location.reload();
            return null;
        })
        .then(data => {
            if (data) location.reload();
        });
}

function deleteItem() {
    const itemId = document.getElementById('itemId').value;
    if (!itemId) return;
    
    const formData = new FormData();
    formData.append('requestId', itemId);
    
    fetch('/client_request_delete', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                modal.hide();
                showToast('success', '삭제되었습니다.');
                setTimeout(() => location.reload(), 1000);
            }
        });
}

// 관리자용 상세 모달 열기
function openDetailModal(requestId) {
    fetch('/get_client_request_content?request_id=' + requestId)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data) {
                const d = data.data;
                document.getElementById('detailRequestId').value = d.request_id;
                document.getElementById('detailTitle').textContent = d.title || '';
                document.getElementById('detailContent').textContent = d.content || '(내용 없음)';
                document.getElementById('detailClientName').textContent = d.client_name || d.user_name || '-';
                document.getElementById('detailCreateDate').textContent = d.create_date || '-';
                
                if (d.admin_checked_at) {
                    document.getElementById('detailCheckBadge').innerHTML = '<span class="badge badge-soft-success">확인완료</span>';
                    document.getElementById('detailBtnCheck').style.display = 'none';
                } else {
                    document.getElementById('detailCheckBadge').innerHTML = '<span class="badge badge-soft-warning">미확인</span>';
                    document.getElementById('detailBtnCheck').style.display = '';
                }
                
                const modal = new bootstrap.Modal(document.getElementById('detailModal'));
                modal.show();
            }
        });
}

// 관리자 상세 모달에서 삭제
function deleteFromDetail() {
    const requestId = document.getElementById('detailRequestId').value;
    if (!requestId) return;
    
    const formData = new FormData();
    formData.append('requestId', requestId);
    
    fetch('/client_request_delete', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('detailModal'));
            modal.hide();
            if (data.success) {
                showToast('success', '삭제되었습니다.');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('danger', '삭제에 실패했습니다.');
            }
        });
}

// 관리자 확인 처리
function checkFromDetail() {
    const requestId = document.getElementById('detailRequestId').value;
    if (!requestId) return;
    
    const formData = new FormData();
    formData.append('requestId', requestId);
    
    fetch('/client_request_check', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('detailModal'));
            modal.hide();
            if (data.success) {
                showToast('success', '확인 처리되었습니다.');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('danger', '처리에 실패했습니다.');
            }
        });
}

// Toast 알림
function showToast(type, message) {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
    toast.show();
    toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1050';
    document.body.appendChild(container);
    return container;
}
</script>
{% endblock %}
