{% extends "layout.html" %}
{% block title %}관리자 대시보드{% endblock %}

{% block content %}
<!-- Welcome Banner -->
<div class="dash-welcome">
  <div class="dash-welcome-content">
    <h2 class="dash-welcome-title">환영합니다, {{ session.login_user.user_name }}님</h2>
    <p class="dash-welcome-text">오늘의 업무 현황을 확인하세요</p>
  </div>
  <div class="dash-welcome-actions">
    <div class="dash-date">
      <i class="bi bi-calendar3"></i>
      <span id="dashDate"></span>
    </div>
    <div class="dash-date">
      <i class="bi bi-clock"></i>
      <span id="dashTime"></span>
    </div>
  </div>
</div>

<!-- KPI Strip -->
<div class="dash-kpi-strip">
  <div class="dash-kpi">
    <div class="dash-kpi-icon primary">
      <i class="ph-duotone ph-buildings"></i>
    </div>
    <div class="dash-kpi-body">
      <div class="dash-kpi-value">{{ kpi.total_client_count|default(0) }}</div>
      <div class="dash-kpi-label">계약업체</div>
    </div>
  </div>

  <div class="dash-kpi">
    <div class="dash-kpi-icon success">
      <i class="ph-duotone ph-broom"></i>
    </div>
    <div class="dash-kpi-body">
      <div class="dash-kpi-value">{{ kpi.cleaning_count|default(0) }}</div>
      <div class="dash-kpi-label">청소 업체</div>
    </div>
  </div>

  <div class="dash-kpi">
    <div class="dash-kpi-icon warning">
      <i class="ph-duotone ph-hamburger"></i>
    </div>
    <div class="dash-kpi-body">
      <div class="dash-kpi-value">{{ kpi.snack_count|default(0) }}</div>
      <div class="dash-kpi-label">간식 업체</div>
    </div>
  </div>

  <div class="dash-kpi">
    <div class="dash-kpi-icon danger">
      <i class="ph-duotone ph-package"></i>
    </div>
    <div class="dash-kpi-body">
      <div class="dash-kpi-value">{{ kpi.supplies_count|default(0) }}</div>
      <div class="dash-kpi-label">비품 업체</div>
    </div>
  </div>
</div>

<!-- Main Content Grid -->
<div class="row g-3">
  <!-- 업체 요청사항 (왼쪽) -->
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div>
          <h5 class="card-title mb-0">업체 요청사항</h5>
          <span class="text-muted small">최근 10건만 표시됩니다</span>
        </div>
        <a href="{{ url_for('homes.notice_list', writer_kind_id=3) }}" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-list me-1"></i>전체보기
        </a>
      </div>
      <div class="card-body p-0">
        {% if client_requests %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th style="width: 120px;">업체명</th>
                <th>제목</th>
                <th style="width: 130px;">등록일</th>
                <th style="width: 60px;"></th>
              </tr>
            </thead>
            <tbody>
              {% for req in client_requests %}
              <tr>
                <td><span class="badge bg-light text-dark">{{ req.ClientName or req.UserName }}</span></td>
                <td class="text-truncate" style="max-width: 400px;">{{ req.Title }}</td>
                <td class="text-muted small">{{ req.CreateDate }}</td>
                <td>
                  <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteNotice({{ req.notice_id }})" title="삭제">
                    <i class="ph ph-trash"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center text-muted py-5">
          <i class="bi bi-inbox" style="font-size: 48px; opacity: 0.3;"></i>
          <p class="mt-3 mb-0">업체 요청사항이 없습니다</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- 이번달 스케줄 현황 (오른쪽) -->
  <div class="col-lg-4">
    {% set sc = schedule_count %}
    {% set c_total = sc.cleaning_total|default(0)|int %}
    {% set c_done = sc.cleaning_completed|default(0)|int %}
    {% set s_total = sc.snack_total|default(0)|int %}
    {% set s_done = sc.snack_completed|default(0)|int %}
    {% set p_total = sc.supplies_total|default(0)|int %}
    {% set p_done = sc.supplies_completed|default(0)|int %}
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">{{ year_month }} 스케줄 현황</h5>
      </div>
      <div class="card-body">
        <div class="device-list">
          <!-- 청소 -->
          <div class="device-item">
            <div class="device-icon">
              <i class="ph-duotone ph-broom"></i>
            </div>
            <div class="device-info">
              <div class="device-name">청소</div>
              <div class="progress device-progress">
                <div class="progress-bar" style="width: {{ (c_done / c_total * 100) if c_total > 0 else 0 }}%"></div>
              </div>
            </div>
            <div class="device-stats">
              <div class="device-percent">{{ ((c_done / c_total * 100)|round|int) if c_total > 0 else 0 }}%</div>
              <div class="device-count">{{ c_done }} / {{ c_total }}</div>
            </div>
          </div>
          <!-- 간식 -->
          <div class="device-item">
            <div class="device-icon">
              <i class="ph-duotone ph-hamburger"></i>
            </div>
            <div class="device-info">
              <div class="device-name">간식</div>
              <div class="progress device-progress">
                <div class="progress-bar bg-warning" style="width: {{ (s_done / s_total * 100) if s_total > 0 else 0 }}%"></div>
              </div>
            </div>
            <div class="device-stats">
              <div class="device-percent">{{ ((s_done / s_total * 100)|round|int) if s_total > 0 else 0 }}%</div>
              <div class="device-count">{{ s_done }} / {{ s_total }}</div>
            </div>
          </div>
          <!-- 비품 -->
          <div class="device-item">
            <div class="device-icon">
              <i class="ph-duotone ph-package"></i>
            </div>
            <div class="device-info">
              <div class="device-name">비품</div>
              <div class="progress device-progress">
                <div class="progress-bar bg-danger" style="width: {{ (p_done / p_total * 100) if p_total > 0 else 0 }}%"></div>
              </div>
            </div>
            <div class="device-stats">
              <div class="device-percent">{{ ((p_done / p_total * 100)|round|int) if p_total > 0 else 0 }}%</div>
              <div class="device-count">{{ p_done }} / {{ p_total }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header">
        <h5 class="card-title mb-0">빠른 메뉴</h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="{{ url_for('homes.notice_list', writer_kind_id=1) }}" class="btn btn-outline-primary">
            <i class="bi bi-megaphone me-2"></i>공지사항 관리
          </a>
          <a href="{{ url_for('homes.notice_list', writer_kind_id=3) }}" class="btn btn-outline-warning">
            <i class="bi bi-chat-dots me-2"></i>업체 요청사항
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// 날짜 및 시간 표시
function updateDateTime() {
  const now = new Date();
  const dateStr = now.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
  const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
  const dateEl = document.getElementById('dashDate');
  const timeEl = document.getElementById('dashTime');
  if (dateEl) dateEl.textContent = dateStr;
  if (timeEl) timeEl.textContent = timeStr;
}
updateDateTime();
setInterval(updateDateTime, 60000);

// 업체 요청사항 삭제
function deleteNotice(noticeId) {
    const formData = new FormData();
    formData.append('noticeId', noticeId);
    
    fetch('/notice_delete', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            if (data.success) location.reload();
            else alert(data.message);
        });
}
</script>
{% endblock %}
