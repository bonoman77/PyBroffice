{% extends "layout.html" %}
{% block title %}관리자 대시보드{% endblock %}

{% block content %}
<!-- Welcome Banner -->
<div class="dash-welcome">
  <div class="dash-welcome-content">
    <h2 class="dash-welcome-title">환영합니다, {{ session.login_user.user_name }}님</h2>
    <p class="dash-welcome-text">오늘의 업무 현황을 확인하세요</p>
  </div>
  <div class="dash-welcome-actions">
    <div class="dash-date">
      <i class="bi bi-calendar3"></i>
      <span id="dashDate"></span>
    </div>
    <div class="dash-date">
      <i class="bi bi-clock"></i>
      <span id="dashTime"></span>
    </div>
  </div>
</div>

<!-- KPI Strip -->
<div class="dash-kpi-strip">
  <div class="dash-kpi">
    <div class="dash-kpi-icon primary">
      <i class="ph-duotone ph-buildings"></i>
    </div>
    <div class="dash-kpi-body">
      <div class="dash-kpi-value">{{ kpi.total_client_count|default(0) }}</div>
      <div class="dash-kpi-label">계약업체</div>
    </div>
  </div>

  <div class="dash-kpi">
    <div class="dash-kpi-icon success">
      <i class="ph-duotone ph-broom"></i>
    </div>
    <div class="dash-kpi-body">
      <div class="dash-kpi-value">{{ kpi.cleaning_count|default(0) }}</div>
      <div class="dash-kpi-label">청소 업체</div>
    </div>
  </div>

  <div class="dash-kpi">
    <div class="dash-kpi-icon warning">
      <i class="ph-duotone ph-hamburger"></i>
    </div>
    <div class="dash-kpi-body">
      <div class="dash-kpi-value">{{ kpi.snack_count|default(0) }}</div>
      <div class="dash-kpi-label">간식 업체</div>
    </div>
  </div>

  <div class="dash-kpi">
    <div class="dash-kpi-icon danger">
      <i class="ph-duotone ph-package"></i>
    </div>
    <div class="dash-kpi-body">
      <div class="dash-kpi-value">{{ kpi.supplies_count|default(0) }}</div>
      <div class="dash-kpi-label">비품 업체</div>
    </div>
  </div>
</div>

<!-- Main Content Grid -->
<div class="row g-3">
  <!-- 업체 요청사항 (왼쪽) -->
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div>
          <h5 class="card-title mb-0">업체 요청사항</h5>
          <span class="text-muted small">최근 10건만 표시됩니다</span>
        </div>
        <a href="{{ url_for('homes.client_request_list') }}" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-list me-1"></i>전체보기
        </a>
      </div>
      <div class="card-body p-0">
        {% if client_requests %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th style="width: 120px;">업체명</th>
                <th>제목</th>
                <th style="width: 80px;">확인</th>
                <th style="width: 120px;">등록일</th>
              </tr>
            </thead>
            <tbody>
              {% for req in client_requests %}
              <tr>
                <td>{{ req.ClientName or req.UserName }}</td>
                <td>
                  <a href="javascript:void(0)" class="text-decoration-none text-dark" onclick="openRequestModal({{ req.request_id }})">
                    {{ req.Title[:30] }}{% if req.Title|length > 30 %}...{% endif %}
                  </a>
                </td>
                <td class="text-center">
                  {% if req.AdminCheckedAt %}
                  <span class="badge badge-soft-success">확인</span>
                  {% else %}
                  <span class="badge badge-soft-warning">미확인</span>
                  {% endif %}
                </td>
                <td class="text-muted small">{{ req.CreateDate[:10] if req.CreateDate else '-' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center text-muted py-5">
          <i class="bi bi-inbox" style="font-size: 48px; opacity: 0.3;"></i>
          <p class="mt-3 mb-0">업체 요청사항이 없습니다</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- 이번달 스케줄 현황 (오른쪽) -->
  <div class="col-lg-4">
    {% set sc = schedule_count %}
    {% set c_total = sc.cleaning_total|default(0)|int %}
    {% set c_done = sc.cleaning_completed|default(0)|int %}
    {% set s_total = sc.snack_total|default(0)|int %}
    {% set s_done = sc.snack_completed|default(0)|int %}
    {% set p_total = sc.supplies_total|default(0)|int %}
    {% set p_done = sc.supplies_completed|default(0)|int %}
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">{{ year_month }} 스케줄 현황</h5>
      </div>
      <div class="card-body">
        <div class="device-list">
          <!-- 청소 -->
          <div class="device-item">
            <div class="device-icon">
              <i class="ph-duotone ph-broom"></i>
            </div>
            <div class="device-info">
              <div class="device-name">청소</div>
              <div class="progress device-progress">
                <div class="progress-bar" style="width: {{ (c_done / c_total * 100) if c_total > 0 else 0 }}%"></div>
              </div>
            </div>
            <div class="device-stats">
              <div class="device-percent">{{ ((c_done / c_total * 100)|round|int) if c_total > 0 else 0 }}%</div>
              <div class="device-count">{{ c_done }} / {{ c_total }}</div>
            </div>
          </div>
          <!-- 간식 -->
          <div class="device-item">
            <div class="device-icon">
              <i class="ph-duotone ph-hamburger"></i>
            </div>
            <div class="device-info">
              <div class="device-name">간식</div>
              <div class="progress device-progress">
                <div class="progress-bar bg-warning" style="width: {{ (s_done / s_total * 100) if s_total > 0 else 0 }}%"></div>
              </div>
            </div>
            <div class="device-stats">
              <div class="device-percent">{{ ((s_done / s_total * 100)|round|int) if s_total > 0 else 0 }}%</div>
              <div class="device-count">{{ s_done }} / {{ s_total }}</div>
            </div>
          </div>
          <!-- 비품 -->
          <div class="device-item">
            <div class="device-icon">
              <i class="ph-duotone ph-package"></i>
            </div>
            <div class="device-info">
              <div class="device-name">비품</div>
              <div class="progress device-progress">
                <div class="progress-bar bg-danger" style="width: {{ (p_done / p_total * 100) if p_total > 0 else 0 }}%"></div>
              </div>
            </div>
            <div class="device-stats">
              <div class="device-percent">{{ ((p_done / p_total * 100)|round|int) if p_total > 0 else 0 }}%</div>
              <div class="device-count">{{ p_done }} / {{ p_total }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header">
        <h5 class="card-title mb-0">빠른 메뉴</h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="{{ url_for('homes.notice_list') }}" class="btn btn-outline-primary">
            <i class="bi bi-megaphone me-2"></i>공지사항 관리
          </a>
          <a href="{{ url_for('homes.client_request_list') }}" class="btn btn-outline-warning">
            <i class="bi bi-chat-dots me-2"></i>업체 요청사항
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 요청사항 상세 모달 -->
<div class="modal fade" id="requestDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">요청사항 상세</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="detailRequestId">
        <div class="mb-3">
          <label class="form-label fw-semibold">제목</label>
          <div id="detailTitle" class="form-control-plaintext"></div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-semibold">내용</label>
          <div id="detailContent" class="form-control-plaintext border rounded p-2" style="min-height: 100px; white-space: pre-wrap;"></div>
        </div>
        <div class="d-flex justify-content-between">
          <div>
            <span class="text-muted small">업체: <strong id="detailClientName"></strong></span>
          </div>
          <div>
            <span class="text-muted small">등록일: <span id="detailCreateDate"></span></span>
          </div>
        </div>
        <div class="mt-2 text-end">
          <span id="detailCheckBadge"></span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger me-auto" id="detailBtnDelete" onclick="deleteRequestFromModal()">
          <i class="ph ph-trash me-1"></i>삭제
        </button>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
        <button type="button" class="btn btn-success" id="detailBtnCheck" onclick="checkRequest()">
          <i class="ph ph-check me-1"></i>확인처리
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// 날짜 및 시간 표시
function updateDateTime() {
  const now = new Date();
  const dateStr = now.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
  const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
  const dateEl = document.getElementById('dashDate');
  const timeEl = document.getElementById('dashTime');
  if (dateEl) dateEl.textContent = dateStr;
  if (timeEl) timeEl.textContent = timeStr;
}
updateDateTime();
setInterval(updateDateTime, 60000);

// 요청사항 상세 모달 열기
function openRequestModal(requestId) {
    fetch('/get_client_request_content?request_id=' + requestId)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data) {
                const d = data.data;
                document.getElementById('detailRequestId').value = d.request_id;
                document.getElementById('detailTitle').textContent = d.title || '';
                document.getElementById('detailContent').textContent = d.content || '(내용 없음)';
                document.getElementById('detailClientName').textContent = d.client_name || d.user_name || '-';
                document.getElementById('detailCreateDate').textContent = d.create_date || '-';
                
                if (d.admin_checked_at) {
                    document.getElementById('detailCheckBadge').innerHTML = '<span class="badge badge-soft-success">확인완료</span>';
                    document.getElementById('detailBtnCheck').style.display = 'none';
                } else {
                    document.getElementById('detailCheckBadge').innerHTML = '<span class="badge badge-soft-warning">미확인</span>';
                    document.getElementById('detailBtnCheck').style.display = '';
                }
                
                const modal = new bootstrap.Modal(document.getElementById('requestDetailModal'));
                modal.show();
            }
        });
}

// 모달에서 삭제
function deleteRequestFromModal() {
    const requestId = document.getElementById('detailRequestId').value;
    if (!requestId) return;
    
    const formData = new FormData();
    formData.append('requestId', requestId);
    
    fetch('/client_request_delete', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('requestDetailModal'));
            modal.hide();
            if (data.success) {
                showToast('success', '삭제되었습니다.');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('danger', '삭제에 실패했습니다.');
            }
        });
}

// 확인 처리
function checkRequest() {
    const requestId = document.getElementById('detailRequestId').value;
    if (!requestId) return;
    
    const formData = new FormData();
    formData.append('requestId', requestId);
    
    fetch('/client_request_check', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('requestDetailModal'));
            modal.hide();
            if (data.success) {
                showToast('success', '확인 처리되었습니다.');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('danger', '처리에 실패했습니다.');
            }
        });
}

// Toast 알림
function showToast(type, message) {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
    toast.show();
    toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1050';
    document.body.appendChild(container);
    return container;
}
</script>
{% endblock %}
