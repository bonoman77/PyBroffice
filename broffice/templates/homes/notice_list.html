{% extends "layout.html" %}
{% set is_request = (writer_kind_id == 3) %}
{% set page_title = '업체 요청사항' if is_request else '공지사항' %}
{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <div>
    <h1 class="page-title">{{ page_title }}</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">홈</a></li>
        <li class="breadcrumb-item active">{{ page_title }}</li>
      </ol>
    </nav>
  </div>
</div>

<div class="card">
  <div class="card-header d-flex align-items-center justify-content-between">
    <div>
      <h5 class="mb-1">{{ page_title }} 목록</h5>
      <div class="d-flex gap-2 mt-2">
        <a href="{{ url_for('homes.notice_list', writer_kind_id=1) }}" class="btn btn-sm {{ 'btn-primary' if writer_kind_id == 1 else 'btn-outline-primary' }}">공지사항</a>
        <a href="{{ url_for('homes.notice_list', writer_kind_id=3) }}" class="btn btn-sm {{ 'btn-warning' if writer_kind_id == 3 else 'btn-outline-warning' }}">업체 요청사항</a>
      </div>
    </div>
    {% if not is_request and session.get('login_user', {}).get('user_kind_id') == 1 %}
    <button class="btn btn-primary" onclick="openNoticeModal()">
      <i class="ph ph-plus me-1"></i> 공지 등록
    </button>
    {% endif %}
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead>
          <tr>
            <th style="width: 50px;"></th>
            <th>제목</th>
            {% if is_request %}
            <th style="width: 120px;">업체명</th>
            {% endif %}
            <th style="width: 100px;">대상</th>
            <th style="width: 100px;">작성자</th>
            {% if session.get('login_user', {}).get('user_kind_id') == 1 %}
            <th style="width: 80px;">게시</th>
            {% endif %}
            <th style="width: 130px;">등록일</th>
          </tr>
        </thead>
        <tbody>
          {% if res_list %}
            {% for res in res_list %}
            <tr style="cursor: {{ 'default' if is_request else 'pointer' }};" {% if not is_request %}onclick="openNoticeModal({{ res.notice_id }})"{% endif %}>
              <td class="text-center">
                {% if res.TopExposeYn %}
                <i class="ph ph-push-pin text-warning"></i>
                {% endif %}
              </td>
              <td class="text-truncate" style="max-width: 400px;">{{ res.Title }}</td>
              {% if is_request %}
              <td><span class="badge bg-light text-dark">{{ res.ClientName or '-' }}</span></td>
              {% endif %}
              <td>
                <span class="badge badge-soft-info">{{ res.TargetUserKindName }}</span>
              </td>
              <td>{{ res.UserName }}</td>
              {% if session.get('login_user', {}).get('user_kind_id') == 1 %}
              <td class="text-center">
                {% if res.DisplayYn %}
                <span class="badge badge-soft-success">게시</span>
                {% else %}
                <span class="badge badge-soft-secondary">비게시</span>
                {% endif %}
              </td>
              {% endif %}
              <td class="text-muted small">{{ res.CreateDate }}</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="8" class="text-center py-5">
                <div class="text-muted">
                  <i class="bi bi-{% if writer_kind_id == 1 %}megaphone{% else %}inbox{% endif %}" style="font-size: 48px; opacity: 0.3;"></i>
                  <p class="mt-3 mb-0">등록된 {{ page_title }}이 없습니다.</p>
                </div>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
  {% if total_pages > 1 %}
  <div class="card-footer d-flex align-items-center justify-content-between">
    <span class="text-muted small">전체 {{ total_count }}건</span>
    <nav>
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item {{ 'disabled' if page <= 1 }}">
          <a class="page-link" href="{{ url_for('homes.notice_list', writer_kind_id=writer_kind_id, page=page-1) }}"><i class="ph ph-caret-left"></i></a>
        </li>
        {% for p in range(1, total_pages + 1) %}
        <li class="page-item {{ 'active' if p == page }}">
          <a class="page-link" href="{{ url_for('homes.notice_list', writer_kind_id=writer_kind_id, page=p) }}">{{ p }}</a>
        </li>
        {% endfor %}
        <li class="page-item {{ 'disabled' if page >= total_pages }}">
          <a class="page-link" href="{{ url_for('homes.notice_list', writer_kind_id=writer_kind_id, page=page+1) }}"><i class="ph ph-caret-right"></i></a>
        </li>
      </ul>
    </nav>
  </div>
  {% elif total_count > 0 %}
  <div class="card-footer">
    <span class="text-muted small">전체 {{ total_count }}건</span>
  </div>
  {% endif %}
</div>

<!-- 등록/수정 모달 -->
<div class="modal fade" id="noticeModal" tabindex="-1" aria-labelledby="noticeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="noticeModalLabel">{{ page_title }} 등록</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="noticeForm">
          <input type="hidden" id="noticeId" name="noticeId">
          {% if session.get('login_user', {}).get('user_kind_id') == 1 %}
          <div class="mb-3">
            <label class="form-label">대상</label>
            <div class="btn-group w-100" role="group">
              <input type="radio" class="btn-check" name="target_user_kind_id" id="targetAll" value="0" autocomplete="off" checked>
              <label class="btn btn-outline-primary" for="targetAll">전체</label>
              <input type="radio" class="btn-check" name="target_user_kind_id" id="targetStaff" value="2" autocomplete="off">
              <label class="btn btn-outline-primary" for="targetStaff">직원</label>
              <input type="radio" class="btn-check" name="target_user_kind_id" id="targetClient" value="3" autocomplete="off">
              <label class="btn btn-outline-primary" for="targetClient">업체</label>
            </div>
          </div>
          {% else %}
          <input type="hidden" name="target_user_kind_id" value="1">
          {% endif %}
          <div class="mb-3">
            <label for="noticeTitle" class="form-label">제목 <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="noticeTitle" name="title" placeholder="제목을 입력하세요" required>
          </div>
          <div class="mb-3">
            <label for="noticeContent" class="form-label">내용</label>
            <textarea class="form-control" id="noticeContent" name="content" rows="6" placeholder="내용을 입력하세요"></textarea>
          </div>
          <div class="d-flex gap-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="topExposeYn" name="top_expose_yn" value="1">
              <label class="form-check-label" for="topExposeYn">
                <i class="ph ph-push-pin me-1"></i>상단 고정
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="displayYn" name="display_yn" value="1" checked>
              <label class="form-check-label" for="displayYn">
                <i class="ph ph-eye me-1"></i>게시
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger me-auto" id="btnNoticeDelete" style="display:none;" onclick="deleteNotice()">
          <i class="ph ph-trash me-1"></i>삭제
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" id="btnNoticeSave" onclick="saveNotice()">등록</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const writerKindId = {{ writer_kind_id }};

function openNoticeModal(noticeId) {
    const modal = new bootstrap.Modal(document.getElementById('noticeModal'));
    const form = document.getElementById('noticeForm');
    form.reset();
    document.getElementById('noticeId').value = '';
    document.getElementById('displayYn').checked = true;
    document.getElementById('btnNoticeDelete').style.display = 'none';
    document.getElementById('noticeModalLabel').textContent = '공지사항 등록';
    const btnSave = document.getElementById('btnNoticeSave');
    btnSave.textContent = '등록';
    btnSave.className = 'btn btn-primary';
    
    if (noticeId) {
        document.getElementById('noticeModalLabel').textContent = '공지사항 수정';
        document.getElementById('btnNoticeDelete').style.display = 'block';
        btnSave.textContent = '수정';
        btnSave.className = 'btn btn-success';
        
        fetch('/get_notice_content?notice_id=' + noticeId)
            .then(r => r.json())
            .then(data => {
                if (data.success && data.data) {
                    const d = data.data;
                    document.getElementById('noticeId').value = d.notice_id;
                    document.getElementById('noticeTitle').value = d.title || '';
                    document.getElementById('noticeContent').value = d.content || '';
                    document.getElementById('topExposeYn').checked = !!d.top_expose_yn;
                    document.getElementById('displayYn').checked = !!d.display_yn;
                    const targetRadio = document.querySelector('input[name="target_user_kind_id"][value="' + (d.target_user_kind_id || 0) + '"]');
                    if (targetRadio) targetRadio.checked = true;
                }
            });
    }
    modal.show();
}

function saveNotice() {
    const noticeId = document.getElementById('noticeId').value;
    const title = document.getElementById('noticeTitle').value.trim();
    if (!title) {
        alert('제목을 입력해주세요.');
        return;
    }
    
    const formData = new FormData(document.getElementById('noticeForm'));
    
    let url = '/notice_list?writer_kind_id=' + writerKindId;
    if (noticeId) {
        url = '/notice_update';
    }
    
    fetch(url, { method: 'POST', body: formData })
        .then(r => {
            if (noticeId) return r.json();
            location.reload();
            return null;
        })
        .then(data => {
            if (data) location.reload();
        });
}

function deleteNotice() {
    const noticeId = document.getElementById('noticeId').value;
    if (!noticeId) return;
    
    const formData = new FormData();
    formData.append('noticeId', noticeId);
    
    fetch('/notice_delete', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            if (data.success) location.reload();
            else alert(data.message);
        });
}
</script>
{% endblock %}