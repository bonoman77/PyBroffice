{% extends "layout.html" %}
{% from "macros/form.html" import input, textarea %}

{% block title %}
  {% if task_kind_id == 4 %}청소업무 계약업체 
  {% elif task_kind_id == 5 %}스낵업무 계약업체
  {% elif task_kind_id == 6 %}비품업무 계약업체
  {% else %}업체 목록
  {% endif %}
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <div>
    <h1 class="page-title">
      {% if task_kind_id == 4 %}
       청소관리 등록업체
      {% elif task_kind_id == 5 %}
       간식관리 등록업체
      {% elif task_kind_id == 6 %}
       비품관리 등록업체
      {% else %}
       업체 목록
      {% endif %}
    </h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">홈</a></li>
        <li class="breadcrumb-item">
          {% if task_kind_id == 4 %}청소관리
          {% elif task_kind_id == 5 %}스낵관리
          {% elif task_kind_id == 6 %}비품관리
          {% else %}업무관리
          {% endif %}
        </li>
        <li class="breadcrumb-item active">등록업체</li>
      </ol>
    </nav>
  </div>
</div>

<!-- Client Stats Strip -->
<div class="users-stats">
  <div class="users-stat-card">
    <div class="users-stat-icon primary"><i class="ph-duotone ph-buildings"></i></div>
    <div class="users-stat-body">
      <div class="users-stat-value">{{ total_clients|default(0) }}</div>
      <div class="users-stat-label">전체 업체</div>
    </div>
  </div>
  <div class="users-stat-card">
    <div class="users-stat-icon success"><i class="ph-duotone ph-check-circle"></i></div>
    <div class="users-stat-body">
      <div class="users-stat-value">{{ active_clients|default(0) }}</div>
      <div class="users-stat-label">활성</div>
    </div>
  </div>
  <div class="users-stat-card">
    <div class="users-stat-icon warning"><i class="ph-duotone ph-clock-countdown"></i></div>
    <div class="users-stat-body">
      <div class="users-stat-value">{{ pending_clients|default(0) }}</div>
      <div class="users-stat-label">검토중</div>
    </div>
  </div>
  <div class="users-stat-card">
    <div class="users-stat-icon danger"><i class="ph-duotone ph-x-circle"></i></div>
    <div class="users-stat-body">
      <div class="users-stat-value">{{ inactive_clients|default(0) }}</div>
      <div class="users-stat-label">비활성</div>
    </div>
  </div>
</div>

<!-- Clients Table Card -->
<div class="card">
  <div class="users-toolbar">
    <div class="users-toolbar-left">
      <div class="users-search">
        <i class="ph ph-magnifying-glass"></i>
        <input type="text" placeholder="업체 검색..." id="clientSearch">
      </div>
      <div class="users-filter-group">
        <div class="dropdown">
          <button class="users-filter-btn" data-bs-toggle="dropdown">
            <i class="ph ph-circle-half"></i> 상태
            <i class="ph ph-caret-down"></i>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item active" href="#" data-filter="status" data-value="all">전체 상태</a></li>
            <li><a class="dropdown-item" href="#" data-filter="status" data-value="active">활성</a></li>
            <li><a class="dropdown-item" href="#" data-filter="status" data-value="pending">검토중</a></li>
            <li><a class="dropdown-item" href="#" data-filter="status" data-value="inactive">비활성</a></li>
          </ul>
        </div>
      </div>
    </div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClientModal">
      <i class="ph ph-plus me-1"></i> 업체 등록
    </button>
  </div>

  <div class="users-table-wrap">
    <table class="users-table">
      <thead>
        <tr>
          <th class="users-th-check">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="selectAll">
            </div>
          </th>
          <th>업체명</th>
          <th>담당자</th>
          <th>연락처</th>
          <th>계약일</th>
          <th>상태</th>
          <th>등록일</th>
          <th class="users-th-actions">작업</th>
        </tr>
      </thead>
      <tbody>
        {% if clients %}
          {% for client in clients %}
          <tr>
            <td>
              <div class="form-check"><input class="form-check-input" type="checkbox"></div>
            </td>
            <td>
              <div class="users-cell-user">
                <div class="users-cell-avatar" style="background: linear-gradient(135deg, 
                  {% if task_kind_id == 4 %}#0ea5e9 0%, #0369a1 100%
                  {% elif task_kind_id == 5 %}#f59e0b 0%, #92400e 100%
                  {% elif task_kind_id == 6 %}#6366f1 0%, #3730a3 100%
                  {% else %}#667eea 0%, #764ba2 100%
                  {% endif %});">
                  <i class="ph 
                    {% if task_kind_id == 4 %}ph-broom
                    {% elif task_kind_id == 5 %}ph-hamburger
                    {% elif task_kind_id == 6 %}ph-package
                    {% else %}ph-buildings
                    {% endif %}"></i>
                </div>
                <div>
                  <a href="/clients/view/{{ client.id }}" class="users-cell-name">{{ client.name }}</a>
                  <div class="users-cell-email">{{ client.business_number|default('사업자번호 미등록') }}</div>
                </div>
              </div>
            </td>
            <td>
              <div>{{ client.manager_name|default('-') }}</div>
              {% if client.manager_position %}
              <div class="users-cell-email">{{ client.manager_position }}</div>
              {% endif %}
            </td>
            <td class="users-cell-meta">
              <div>{{ client.phone|default('-') }}</div>
              {% if client.manager_phone %}
              <div class="users-cell-email">{{ client.manager_phone }}</div>
              {% endif %}
            </td>
            <td class="users-cell-meta">{{ client.contract_date|default('-') }}</td>
            <td>
              {% if client.status == 'active' %}
              <span class="users-status active"><span class="users-status-dot"></span> 활성</span>
              {% elif client.status == 'pending' %}
              <span class="users-status pending"><span class="users-status-dot"></span> 검토중</span>
              {% else %}
              <span class="users-status inactive"><span class="users-status-dot"></span> 비활성</span>
              {% endif %}
            </td>
            <td class="users-cell-meta">{{ client.registered_date|default('알 수 없음') }}</td>
            <td>
              <div class="users-actions">
                <a href="/clients/view/{{ client.id }}" class="users-action-btn" title="보기"><i class="ph ph-eye"></i></a>
                <button class="users-action-btn" title="수정" onclick="editClient({{ client.id }}, {{ client|tojson }})"><i class="ph ph-pencil-simple"></i></button>
                <button class="users-action-btn danger" title="삭제" onclick="deleteClient({{ client.id }})"><i class="ph ph-trash"></i></button>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="8" class="text-center py-5">
              <div class="text-muted">
                <i class="ph 
                  {% if task_kind_id == 4 %}ph-broom
                  {% elif task_kind_id == 5 %}ph-hamburger
                  {% elif task_kind_id == 6 %}ph-package
                  {% else %}ph-buildings
                  {% endif %}" style="font-size: 48px; opacity: 0.3;"></i>
                <p class="mt-3 mb-0">등록된 업체가 없습니다.</p>
              </div>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if clients and clients|length > 0 %}
  <div class="users-pagination">
    <div class="users-pagination-info">
      Showing <strong>1-{{ clients|length }}</strong> of <strong>{{ total_clients|default(clients|length) }}</strong> clients
    </div>
    <nav>
      <ul class="pagination mb-0">
        <li class="page-item disabled">
          <a class="page-link" href="#"><i class="ph ph-caret-left"></i></a>
        </li>
        <li class="page-item active"><a class="page-link" href="#">1</a></li>
        <li class="page-item"><a class="page-link" href="#">2</a></li>
        <li class="page-item"><a class="page-link" href="#">3</a></li>
        <li class="page-item">
          <a class="page-link" href="#"><i class="ph ph-caret-right"></i></a>
        </li>
      </ul>
    </nav>
  </div>
  {% endif %}
</div>

<!-- Add Client Modal -->
<div class="modal fade" id="addClientModal" tabindex="-1" aria-labelledby="addClientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addClientModalLabel">
          {% if task_kind_id == 4 %}청소
          {% elif task_kind_id == 5 %}스낵
          {% elif task_kind_id == 6 %}비품
          {% endif %} 업체 등록
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addClientForm">
          <input type="hidden" id="taskKindId" name="taskKindId" value="{{ task_kind_id }}">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="clientName" class="form-label">업체명 <span class="text-danger">*</span></label>
              {{ input('text', 'clientName', '', opt='required') }}
            </div>
            <div class="col-md-6 mb-3">
              <label for="clientBusinessNumber" class="form-label">사업자등록번호</label>
              {{ input('text', 'clientBusinessNumber', '', placeholder='000-00-00000') }}
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="clientPhone" class="form-label">업체 연락처 <span class="text-danger">*</span></label>
              {{ input('tel', 'clientPhone', '', opt='required') }}
            </div>
            <div class="col-md-6 mb-3">
              <label for="contractDate" class="form-label">계약일 <span class="text-danger">*</span></label>
              {{ input('date', 'contractDate', '', opt='required') }}
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="clientManager" class="form-label">담당자명</label>
              {{ input('text', 'clientManager', '') }}
            </div>
            <div class="col-md-4 mb-3">
              <label for="managerPosition" class="form-label">담당자 직급</label>
              {{ input('text', 'managerPosition', '', placeholder='예: 과장, 팀장') }}
            </div>
            <div class="col-md-4 mb-3">
              <label for="managerPhone" class="form-label">담당자 연락처</label>
              {{ input('tel', 'managerPhone', '', placeholder='010-0000-0000') }}
            </div>
          </div>
          <div class="mb-3">
            <label for="clientAddress" class="form-label">주소</label>
            {{ input('text', 'clientAddress', '') }}
          </div>
          <div class="mb-3">
            <label for="memo" class="form-label">비고</label>
            {{ textarea('memo', '', rows='3') }}
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" onclick="submitAddClient()">등록</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Client Modal -->
<div class="modal fade" id="editClientModal" tabindex="-1" aria-labelledby="editClientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editClientModalLabel">
          {% if task_kind_id == 4 %}청소
          {% elif task_kind_id == 5 %}스낵
          {% elif task_kind_id == 6 %}비품
          {% endif %} 업체 수정
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editClientForm">
          <input type="hidden" id="editClientId" name="clientId">
          <input type="hidden" id="editTaskKindId" name="taskKindId" value="{{ task_kind_id }}">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editClientName" class="form-label">업체명 <span class="text-danger">*</span></label>
              {{ input('text', 'editClientName', '', opt='required') }}
            </div>
            <div class="col-md-6 mb-3">
              <label for="editClientBusinessNumber" class="form-label">사업자등록번호</label>
              {{ input('text', 'editClientBusinessNumber', '', placeholder='000-00-00000') }}
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editClientPhone" class="form-label">업체 연락처 <span class="text-danger">*</span></label>
              {{ input('tel', 'editClientPhone', '', opt='required') }}
            </div>
            <div class="col-md-6 mb-3">
              <label for="editContractDate" class="form-label">계약일 <span class="text-danger">*</span></label>
              {{ input('date', 'editContractDate', '', opt='required') }}
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="editClientManager" class="form-label">담당자명</label>
              {{ input('text', 'editClientManager', '') }}
            </div>
            <div class="col-md-4 mb-3">
              <label for="editManagerPosition" class="form-label">담당자 직급</label>
              {{ input('text', 'editManagerPosition', '', placeholder='예: 과장, 팀장') }}
            </div>
            <div class="col-md-4 mb-3">
              <label for="editManagerPhone" class="form-label">담당자 연락처</label>
              {{ input('tel', 'editManagerPhone', '', placeholder='010-0000-0000') }}
            </div>
          </div>
          <div class="mb-3">
            <label for="editClientAddress" class="form-label">주소</label>
            {{ input('text', 'editClientAddress', '') }}
          </div>
          <div class="mb-3">
            <label for="editMemo" class="form-label">비고</label>
            {{ textarea('editMemo', '', rows='3') }}
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" onclick="submitEditClient()">수정</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Select All Checkbox
document.getElementById('selectAll')?.addEventListener('change', function() {
  const checkboxes = document.querySelectorAll('.users-table tbody input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = this.checked);
});

// Search Functionality
document.getElementById('clientSearch')?.addEventListener('input', function(e) {
  const searchTerm = e.target.value.toLowerCase();
  const rows = document.querySelectorAll('.users-table tbody tr');
  
  rows.forEach(row => {
    const name = row.querySelector('.users-cell-name')?.textContent.toLowerCase() || '';
    const businessNumber = row.querySelector('.users-cell-email')?.textContent.toLowerCase() || '';
    
    if (name.includes(searchTerm) || businessNumber.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
});

// Filter Functionality
document.querySelectorAll('[data-filter]').forEach(item => {
  item.addEventListener('click', function(e) {
    e.preventDefault();
    const filterType = this.dataset.filter;
    const filterValue = this.dataset.value;
    
    // Update active state
    this.closest('.dropdown-menu').querySelectorAll('.dropdown-item').forEach(i => {
      i.classList.remove('active');
    });
    this.classList.add('active');
    
    // Apply filter
    const rows = document.querySelectorAll('.users-table tbody tr');
    rows.forEach(row => {
      if (filterValue === 'all') {
        row.style.display = '';
      } else {
        const cellText = row.querySelector('.users-status')?.textContent.toLowerCase() || '';
        if (cellText.includes(filterValue)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      }
    });
  });
});

// Add Client Form Submit
function submitAddClient() {
  const form = document.getElementById('addClientForm');
  
  if (form.checkValidity()) {
    const formData = {
      task_kind_id: document.getElementById('taskKindId').value,
      name: document.getElementById('clientName').value,
      business_number: document.getElementById('clientBusinessNumber').value,
      phone: document.getElementById('clientPhone').value,
      contract_date: document.getElementById('contractDate').value,
      manager: document.getElementById('clientManager').value,
      manager_position: document.getElementById('managerPosition').value,
      manager_phone: document.getElementById('managerPhone').value,
      address: document.getElementById('clientAddress').value,
      memo: document.getElementById('memo').value
    };
    
    // TODO: Send AJAX request to add client
    console.log('Adding client:', formData);
    
    // Close modal and reset form
    const modal = bootstrap.Modal.getInstance(document.getElementById('addClientModal'));
    modal.hide();
    form.reset();
    
    // Show success message
    alert('업체가 등록되었습니다.');
    location.reload();
  } else {
    form.reportValidity();
  }
}

// Edit Client - Load data into modal
function editClient(clientId, clientData) {
  // Populate form fields
  document.getElementById('editClientId').value = clientId;
  document.getElementById('editClientName').value = clientData.name || '';
  document.getElementById('editClientBusinessNumber').value = clientData.business_number || '';
  document.getElementById('editClientPhone').value = clientData.phone || '';
  document.getElementById('editContractDate').value = clientData.contract_date || '';
  document.getElementById('editClientManager').value = clientData.manager || '';
  document.getElementById('editManagerPosition').value = clientData.manager_position || '';
  document.getElementById('editManagerPhone').value = clientData.manager_phone || '';
  document.getElementById('editClientAddress').value = clientData.address || '';
  document.getElementById('editMemo').value = clientData.memo || '';
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('editClientModal'));
  modal.show();
}

// Edit Client Form Submit
function submitEditClient() {
  const form = document.getElementById('editClientForm');
  
  if (form.checkValidity()) {
    const formData = {
      client_id: document.getElementById('editClientId').value,
      task_kind_id: document.getElementById('editTaskKindId').value,
      name: document.getElementById('editClientName').value,
      business_number: document.getElementById('editClientBusinessNumber').value,
      phone: document.getElementById('editClientPhone').value,
      contract_date: document.getElementById('editContractDate').value,
      manager: document.getElementById('editClientManager').value,
      manager_position: document.getElementById('editManagerPosition').value,
      manager_phone: document.getElementById('editManagerPhone').value,
      address: document.getElementById('editClientAddress').value,
      memo: document.getElementById('editMemo').value
    };
    
    // TODO: Send AJAX request to update client
    console.log('Updating client:', formData);
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('editClientModal'));
    modal.hide();
    
    // Show success message
    alert('업체 정보가 수정되었습니다.');
    location.reload();
  } else {
    form.reportValidity();
  }
}

// Delete Client
function deleteClient(clientId) {
  if (confirm('정말로 이 업체를 삭제하시겠습니까?')) {
    // TODO: Send AJAX request to delete client
    console.log('Deleting client:', clientId);
    alert('업체가 삭제되었습니다.');
    location.reload();
  }
}
</script>
{% endblock %}
