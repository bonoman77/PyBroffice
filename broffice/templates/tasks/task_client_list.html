{% extends "layout.html" %}
{% set user_kind = session.get('login_user', {}).get('user_kind_id', 0) %}
{% set page_title = '작업 결과 확인' %}
{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <div>
    <h1 class="page-title">
      {% if task_kind_id == 4 %}청소{% elif task_kind_id == 5 %}간식{% elif task_kind_id == 6 %}비품{% else %}작업{% endif %} 
      {{ page_title }}
    </h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">홈</a></li>
        <li class="breadcrumb-item">
          {% if task_kind_id == 4 %}청소{% elif task_kind_id == 5 %}간식{% elif task_kind_id == 6 %}비품{% else %}작업{% endif %}
        </li>
        <li class="breadcrumb-item active">{{ page_title }}</li>
      </ol>
    </nav>
  </div>
</div>

<!-- 필터 영역 -->
<div class="row mb-3">
  <div class="col-12">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <!-- 월 선택 -->
      <div class="d-flex align-items-center gap-2">
        {% if user_kind == 1 %}
                <!-- 관리자: 업체 검색 -->
                <select class="form-select form-select-sm" id="clientFilter" style="width: 200px;" onchange="filterByClient()">
                <option value="0">전체 업체</option>
                {% for c in clients %}
                <option value="{{ c.client_id }}" {{ 'selected' if c.client_id == client_id }}>{{ c.client_name }}</option>
                {% endfor %}
                </select>
        {% endif %}
        <button class="btn btn-sm btn-outline-secondary" onclick="changeMonth(-1)" title="이전 달">
          <i class="ph ph-caret-left"></i>
        </button>
        <span class="fw-semibold fs-15 px-2">
          <i class="bi bi-calendar-month me-1"></i>{{ year_month }}
        </span>
        <button class="btn btn-sm btn-outline-secondary" onclick="changeMonth(1)" title="다음 달">
          <i class="ph ph-caret-right"></i>
        </button>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-primary px-3 py-2">
          <i class="ph ph-list-checks me-1"></i>전체 <strong>{{ total_count }}</strong>건
        </span>
      </div>
    </div>
  </div>
</div>

{% if res_list %}
  {% for res in res_list %}
  <div class="card mb-3 shadow-sm">
    <div class="card-body py-3 px-3">
      <div class="d-flex align-items-start justify-content-between">
        <!-- 좌측: 작업 정보 -->
        <div class="flex-grow-1">
          <div class="d-flex align-items-center gap-2 mb-2">
            <span class="fw-semibold">{{ res.effective_date }}</span>
            {% if res.task_kind_id == 4 %}
            <span class="badge badge-soft-primary">{{ res.task_kind_name }}</span>
            {% elif res.task_kind_id == 5 %}
            <span class="badge badge-soft-warning">{{ res.task_kind_name }}</span>
            {% elif res.task_kind_id == 6 %}
            <span class="badge badge-soft-danger">{{ res.task_kind_name }}</span>
            {% else %}
            <span class="badge badge-soft-secondary">{{ res.task_kind_name }}</span>
            {% endif %}
            {% if user_kind == 1 %}
            <span class="badge bg-light text-dark">{{ res.client_name }}</span>
            {% endif %}
            <span class="text-muted small">{{ res.area_count }}구역</span>
          </div>
          <!-- 현장작업팀장 / 관리팀장 -->
          <div class="d-flex flex-wrap gap-3 small">
            <div>
              <span class="text-muted">현장작업팀장:</span>
              <strong>{{ res.worker_name or '-' }}</strong>
              {% if res.worker_mobile %}
              <a href="tel:{{ res.worker_mobile }}" class="text-muted ms-1" onclick="event.stopPropagation();"><i class="ph ph-phone"></i> {{ res.worker_mobile }}</a>
              {% endif %}
            </div>
            {% if res.manager_name %}
            <div>
              <span class="text-muted">관리팀장:</span>
              <strong>{{ res.manager_name }}</strong>
              {% if res.manager_mobile %}
              <a href="tel:{{ res.manager_mobile }}" class="text-muted ms-1" onclick="event.stopPropagation();"><i class="ph ph-phone"></i> {{ res.manager_mobile }}</a>
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      <!-- 하단: 완료일시 + 버튼 -->
      <div class="d-flex align-items-center justify-content-between mt-2 pt-2 border-top">
        <div class="small text-muted">
          <i class="ph ph-check-circle text-success me-1"></i>완료: {{ res.completed_date }}
        </div>
        <div class="d-flex gap-2">
          <a href="{{ url_for('tasks.task_detail', task_schedule_id=res.task_schedule_id, task_kind_id=res.task_kind_id) }}" 
             class="btn btn-sm btn-outline-primary">
            <i class="ph ph-list-checks me-1"></i>세부 확인
          </a>
          {% if res.photo_count %}
          <button type="button" class="btn btn-sm btn-outline-secondary" 
                  onclick="showSchedulePhotos({{ res.task_schedule_id }}, '{{ res.effective_date }} - {{ res.client_name }}')">
            <i class="ph ph-camera me-1"></i>사진 {{ res.photo_count }}장
          </button>
          {% else %}
          <span class="btn btn-sm btn-outline-secondary disabled">
            <i class="ph ph-camera me-1"></i>사진 없음
          </span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endfor %}

  <!-- 페이징 -->
  {% if total_pages > 1 %}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <span class="text-muted small">전체 {{ total_count }}건</span>
    <nav>
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item {{ 'disabled' if page <= 1 }}">
          <a class="page-link" href="{{ url_for('tasks.task_client_list', task_kind_id=task_kind_id, page=page-1, year_month=year_month, client_id=client_id) }}"><i class="ph ph-caret-left"></i></a>
        </li>
        {% for p in range(1, total_pages + 1) %}
        <li class="page-item {{ 'active' if p == page }}">
          <a class="page-link" href="{{ url_for('tasks.task_client_list', task_kind_id=task_kind_id, page=p, year_month=year_month, client_id=client_id) }}">{{ p }}</a>
        </li>
        {% endfor %}
        <li class="page-item {{ 'disabled' if page >= total_pages }}">
          <a class="page-link" href="{{ url_for('tasks.task_client_list', task_kind_id=task_kind_id, page=page+1, year_month=year_month, client_id=client_id) }}"><i class="ph ph-caret-right"></i></a>
        </li>
      </ul>
    </nav>
  </div>
  {% elif total_count > 0 %}
  <div class="mb-3">
    <span class="text-muted small">전체 {{ total_count }}건</span>
  </div>
  {% endif %}
{% else %}
  <div class="text-center text-muted py-5">
    <i class="bi bi-clipboard-check" style="font-size: 48px; opacity: 0.3;"></i>
    <p class="mt-3 mb-0">완료된 작업이 없습니다.</p>
  </div>
{% endif %}

<!-- 사진 Carousel 모달 -->
<div class="modal fade" id="schedulePhotoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark">
      <div class="modal-header py-2 border-0">
        <h6 class="modal-title text-white" id="schedulePhotoTitle">사진</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center p-0">
        <div id="schedulePhotoCarousel" class="carousel slide" data-bs-ride="false">
          <div class="carousel-inner" id="scheduleCarouselInner"></div>
          <button class="carousel-control-prev" type="button" data-bs-target="#schedulePhotoCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#schedulePhotoCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
          </button>
        </div>
        <div class="text-white small py-2" id="schedulePhotoCounter"></div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function changeMonth(offset) {
    const current = '{{ year_month }}';
    const [year, month] = current.split('-').map(Number);
    const d = new Date(year, month - 1 + offset, 1);
    const ym = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
    const clientId = document.getElementById('clientFilter') ? document.getElementById('clientFilter').value : 0;
    window.location.href = '/tasks/task_client_list/{{ task_kind_id }}?year_month=' + ym + '&client_id=' + clientId;
}

function filterByClient() {
    const clientId = document.getElementById('clientFilter').value;
    window.location.href = '/tasks/task_client_list/{{ task_kind_id }}?year_month={{ year_month }}&client_id=' + clientId;
}

let scheduleCarouselInstance = null;

function showSchedulePhotos(scheduleId, title) {
    document.getElementById('schedulePhotoTitle').textContent = title;
    const inner = document.getElementById('scheduleCarouselInner');
    const counter = document.getElementById('schedulePhotoCounter');
    inner.innerHTML = '<div class="text-white py-5">불러오는 중...</div>';
    counter.textContent = '';

    const modalEl = document.getElementById('schedulePhotoModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();

    fetch('/tasks/task_schedule_photos/' + scheduleId)
        .then(r => r.json())
        .then(data => {
            const photos = data.photos || [];
            if (photos.length === 0) {
                inner.innerHTML = '<div class="text-white py-5">사진이 없습니다.</div>';
                return;
            }
            inner.innerHTML = '';
            photos.forEach((p, i) => {
                const item = document.createElement('div');
                item.className = 'carousel-item' + (i === 0 ? ' active' : '');
                item.innerHTML = '<img src="' + p.photo_file_path + '" class="d-block w-100" style="max-height:70vh; object-fit:contain;">' +
                    '<div class="text-white small mt-1">' + (p.area_name || '') + '</div>';
                inner.appendChild(item);
            });
            counter.textContent = '1 / ' + photos.length;

            const carouselEl = document.getElementById('schedulePhotoCarousel');
            if (scheduleCarouselInstance) scheduleCarouselInstance.dispose();
            scheduleCarouselInstance = new bootstrap.Carousel(carouselEl, { keyboard: true, wrap: true });

            carouselEl.removeEventListener('slid.bs.carousel', carouselEl._counterHandler);
            carouselEl._counterHandler = function() {
                const active = inner.querySelector('.carousel-item.active');
                const items = inner.querySelectorAll('.carousel-item');
                const idx = Array.from(items).indexOf(active) + 1;
                counter.textContent = idx + ' / ' + items.length;
            };
            carouselEl.addEventListener('slid.bs.carousel', carouselEl._counterHandler);
        })
        .catch(() => {
            inner.innerHTML = '<div class="text-white py-5">사진을 불러올 수 없습니다.</div>';
        });
}

// 모달 열릴 때 키보드 이벤트 바인딩
document.getElementById('schedulePhotoModal').addEventListener('shown.bs.modal', function() {
    document.addEventListener('keydown', schedulePhotoKeyHandler);
});
document.getElementById('schedulePhotoModal').addEventListener('hidden.bs.modal', function() {
    document.removeEventListener('keydown', schedulePhotoKeyHandler);
});
function schedulePhotoKeyHandler(e) {
    if (!scheduleCarouselInstance) return;
    if (e.key === 'ArrowLeft') scheduleCarouselInstance.prev();
    else if (e.key === 'ArrowRight') scheduleCarouselInstance.next();
}
</script>
{% endblock %}
