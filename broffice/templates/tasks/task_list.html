{% extends "layout.html" %}
{% from "macros/form.html" import input, textarea, datepicker %}

{% block title %}
  {% if task_kind_id == 4 %}청소 작업
  {% elif task_kind_id == 5 %}간식 작업
  {% elif task_kind_id == 6 %}비품 작업
  {% else %}업체 목록
  {% endif %}
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <div>
    <h1 class="page-title">
      {% if task_kind_id == 4 %}
       청소 관리
      {% elif task_kind_id == 5 %}
       간식 관리
      {% elif task_kind_id == 6 %}
       비품 관리
      {% else %}
       업체 목록
      {% endif %}
    </h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">홈</a></li>
        <li class="breadcrumb-item">
          {% if task_kind_id == 4 %}청소
          {% elif task_kind_id == 5 %}간식
          {% elif task_kind_id == 6 %}비품
          {% else %}작업
          {% endif %}
        </li>
        <li class="breadcrumb-item active"> 관리</li>
      </ol>
    </nav>
  </div>
</div>

<!-- Clients Table Card -->
<div class="card">
  <div class="users-toolbar">
    <div class="users-toolbar-left">
      <div class="users-search">
        <i class="ph ph-magnifying-glass"></i>
        <input type="text" placeholder="업체 / 작업자 검색..." id="clientSearch">
      </div>
      <div class="users-filter-group">
        <div class="dropdown">
          <button class="users-filter-btn" data-bs-toggle="dropdown">
            <i class="ph ph-circle-half"></i> 상태
            <i class="ph ph-caret-down"></i>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item active" href="#" data-filter="status" data-value="all">전체</a></li>
            <li><a class="dropdown-item" href="#" data-filter="status" data-value="active">활성</a></li>
            <li><a class="dropdown-item" href="#" data-filter="status" data-value="pending">대기</a></li>
            <li><a class="dropdown-item" href="#" data-filter="status" data-value="inactive">비활성</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="users-toolbar-right">
      <button class="btn btn-primary" onclick="openTaskModal()">
        <i class="ph ph-calendar-plus me-2"></i>작업 등록
      </button>
    </div>
  </div>

  <div class="users-table-wrap">
    <table class="users-table">
      <thead>
        <tr>
          <th class="users-th-check">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="selectAll">
            </div>
          </th>
          <th>업체명</th>
          <th>작업자</th>
          <th>작업주기</th>
          <th>구역수</th>
          <th>상태</th>
          <th>당월/익월</th>
          <th class="users-th-actions">작업</th>
        </tr>
      </thead>
      <tbody>
        {% if tasks %}
          {% for task in tasks %}
          <tr data-task-id="{{ task.task_id }}">
            <td>
              <div class="form-check"><input class="form-check-input row-check" type="checkbox" value="{{ task.task_id }}"></div>
            </td>
            <td>
              <div class="users-cell-user">
               <div>
                  <span class="users-cell-name">{{ task.client_name }}</span>
                </div>
              </div>
            </td>
            <td class="users-cell-meta">
              <div>{{ task.user_name }}</div>
              <div class="users-cell-email">{{ task.user_mobile }}</div>
            </td>
            <td class="users-cell-meta">
              <div>{{ task.day_of_week }}</div>
            </td>
            <td class="users-cell-meta text-center">
              <div>{{ task.area_count }}</div>
            </td>
            <td class="text-center">
              {% if task.task_status == 'active' %}
                <span class="users-status active">활성</span>
              {% elif task.task_status == 'pending' %}
                <span class="users-status pending">대기</span>
              {% else %}
                <span class="users-status inactive">비활성</span>
              {% endif %}
            </td>
            <td class="users-cell-meta text-center">
              <div>{{ task.current_month_schedule_count }} / {{ task.next_month_schedule_count }}</div>
            </td>
            <td>
              <div class="table-actions justify-content-end">
                <button class="btn btn-icon btn-sm btn-light" title="작업변경" onclick='editTaskModal({{ task|tojson|safe }})'><i class="ph ph-pencil-simple"></i></button>
                <a href="{{ url_for('tasks.task_area_list', task_id=task.task_id, task_kind_id=task_kind_id) }}" class="btn btn-icon btn-sm btn-light" title="구역등록"><i class="ph ph-map-pin"></i></a>
                <button class="btn btn-icon btn-sm btn-light text-danger" title="삭제" data-task-id="{{ task.task_id }}" data-client-name="{{ task.client_name }}" onclick="showDeleteTaskModal(this)"><i class="ph ph-trash"></i></button>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="8" class="text-center py-5">
              <div class="text-muted">
                <i class="ph 
                  {% if task_kind_id == 4 %}ph-broom
                  {% elif task_kind_id == 5 %}ph-hamburger
                  {% elif task_kind_id == 6 %}ph-package
                  {% else %}ph-buildings
                  {% endif %}" style="font-size: 48px; opacity: 0.3;"></i>
                <p class="mt-3 mb-0">등록된 작업이 없습니다.</p>
              </div>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="users-pagination" id="tasksPagination" style="display: none;">
    <div class="users-pagination-info">
      <strong id="showingRange">1-10</strong> / <strong id="totalCount">0</strong> 건
    </div>
    <nav>
      <ul class="pagination mb-0" id="paginationList">
        <!-- 페이지 버튼이 동적으로 생성됩니다 -->
      </ul>
    </nav>
  </div>
</div>

<!-- 스케줄 생성 -->
<div class="card mt-3">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between">
      <h6 class="mb-0"><i class="ph ph-calendar-dots me-2"></i>스케줄 생성</h6>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-primary" onclick="generateSchedule('current', 'all')">
          <i class="ph ph-calendar-plus me-1"></i>당월전체
        </button>
        <button class="btn btn-sm btn-outline-primary" onclick="generateSchedule('current', 'selected')">
          <i class="ph ph-check-square me-1"></i>당월선택
        </button>
        <button class="btn btn-sm btn-success" onclick="generateSchedule('next', 'all')">
          <i class="ph ph-calendar-plus me-1"></i>익월전체
        </button>
        <button class="btn btn-sm btn-outline-success" onclick="generateSchedule('next', 'selected')">
          <i class="ph ph-check-square me-1"></i>익월선택
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Task Modal -->
<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center py-4">
        <div class="mb-3">
          <span class="bg-danger-subtle text-danger rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
            <i class="bi bi-exclamation-triangle fs-1"></i>
          </span>
        </div>
        <h5>작업 삭제</h5>
        <p class="text-muted mb-2">정말로 <strong id="deleteTaskClientName"></strong> 작업을 삭제하시겠습니까?</p>
        <p class="text-danger mb-0 small">이 작업을 삭제하면 생성된 모든 스케줄이 함께 삭제됩니다.</p>
        <input type="hidden" id="deleteTaskId">
      </div>
      <div class="modal-footer justify-content-center border-0 pt-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-danger" onclick="confirmDeleteTask()">삭제</button>
      </div>
    </div>
  </div>
</div>

<!-- Generate Schedule Modal -->
<div class="modal fade" id="generateScheduleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center py-4">
        <div class="mb-3">
          <span class="bg-primary-subtle text-primary rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
            <i class="bi bi-calendar-plus fs-1"></i>
          </span>
        </div>
        <h5>스케줄 생성</h5>
        <p class="text-muted mb-0" id="generateScheduleMessage"></p>
      </div>
      <div class="modal-footer justify-content-center border-0 pt-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" id="confirmGenerateBtn">생성</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addTaskModalLabel">
          {% if task_kind_id == 4 %}청소
          {% elif task_kind_id == 5 %}간식
          {% elif task_kind_id == 6 %}비품
          {% endif %} 작업 등록
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addTaskForm">
          <input type="hidden" id="taskKindId" name="taskKindId" value="{{ task_kind_id }}">
          <input type="hidden" id="taskId" name="taskId">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="clientId" class="form-label">업체 <span class="text-danger">*</span></label>
              <select class="form-select" id="clientId" name="clientId" required>
                <option value="">업체 선택</option>
                {% for client in clients %}
                <option value="{{ client.client_id }}">{{ client.client_name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="userId" class="form-label">작업자 <span class="text-danger">*</span></label>
              <select class="form-select" id="userId" name="userId" required>
                <option value="">작업자 선택</option>
              </select>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="daysOfWeek" class="form-label">요일</label>
              <div class="d-flex gap-2">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day1" name="daysOfWeek" value="1">
                  <label class="form-check-label" for="day1">월</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day2" name="daysOfWeek" value="2">
                  <label class="form-check-label" for="day2">화</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day3" name="daysOfWeek" value="3">
                  <label class="form-check-label" for="day3">수</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day4" name="daysOfWeek" value="4">
                  <label class="form-check-label" for="day4">목</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day5" name="daysOfWeek" value="5">
                  <label class="form-check-label" for="day5">금</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day6" name="daysOfWeek" value="6">
                  <label class="form-check-label" for="day6">토</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day7" name="daysOfWeek" value="7">
                  <label class="form-check-label" for="day7">일</label>
                </div>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="fixDates" class="form-label">월별 고정 날짜 (선택사항)</label>
              <input type="text" class="form-control" id="fixDates" name="fixDates" placeholder="예: 15, 25 (콤마로 구분)">
              <div class="form-text">월별 업무일 경우 날짜를 입력하세요. 여러 날짜는 콤마로 구분합니다.</div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="serviceStartedAt" class="form-label">관리 시작일 <span class="text-danger">*</span></label>
              {{ datepicker('serviceStartedAt', '', 'date', '시작일 선택', opt='required') }}
            </div>
            <div class="col-md-6 mb-3">
              <label for="serviceEndedAt" class="form-label">관리 종료일</label>
              {{ datepicker('serviceEndedAt', '', 'date', '종료일 선택') }}
            </div>
          </div>
          
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="useYn" name="useYn" checked>
              <label class="form-check-label" for="useYn">
                사용
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" id="taskSubmitBtn" onclick="submitTask()">등록</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// 페이징 인스턴스 생성
const taskPagination = new TablePagination({
  tableSelector: '.users-table tbody',
  paginationSelector: '#tasksPagination',
  itemsPerPage: 10  
});

// 커스텀 필터 함수 정의 (task_status 기준)
taskPagination.customFilter = function(row, filters) {
  if (filters.status && filters.status !== 'all') {
    const statusElement = row.querySelector('.users-status');
    if (!statusElement) return false;
    if (!statusElement.classList.contains(filters.status)) return false;
  }
  return true;
};

// Select All Checkbox
document.getElementById('selectAll')?.addEventListener('change', function() {
  const checkboxes = document.querySelectorAll('.users-table tbody input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = this.checked);
});

// 검색 기능 (업체명 + 작업자)
document.getElementById('clientSearch')?.addEventListener('input', function(e) {
  taskPagination.applySearchFilter(e.target.value, ['.users-cell-name', '.users-cell-meta']);
});

// 필터 기능
document.querySelectorAll('[data-filter]').forEach(item => {
  item.addEventListener('click', function(e) {
    e.preventDefault();
    const filterType = this.dataset.filter;
    const filterValue = this.dataset.value;
    
    // 활성 상태 업데이트
    this.closest('.dropdown-menu').querySelectorAll('.dropdown-item').forEach(i => {
      i.classList.remove('active');
    });
    this.classList.add('active');
    
    // 필터 적용
    taskPagination.setFilter(filterType, filterValue);
  });
});

// 작업 모달 열기
function openTaskModal() {
    const modal = new bootstrap.Modal(document.getElementById('addTaskModal'));
    
    // 폼 초기화
    document.getElementById('addTaskForm').reset();
    document.getElementById('taskId').value = '';
    
    // 등록 모드 설정
    document.getElementById('addTaskModalLabel').innerHTML = 
        '{% if task_kind_id == 4 %}청소{% elif task_kind_id == 5 %}간식{% elif task_kind_id == 6 %}비품{% endif %} 작업 등록';
    const submitBtn = document.getElementById('taskSubmitBtn');
    submitBtn.textContent = '등록';
    submitBtn.className = 'btn btn-primary';
    
    // 작업자 목록 로드
    loadUsers();
    
    modal.show();
}

// 사용자 목록 로드
function loadUsers() {
    const userSelect = document.getElementById('userId');
    userSelect.innerHTML = '<option value="">작업자 선택</option>';
    
    // 서버에서 작업자 목록 가져오기
    const workersData = {{ workers|tojson|safe }};
    
    workersData.forEach(worker => {
        const option = document.createElement('option');
        option.value = worker.user_id;
        option.textContent = worker.user_name;
        userSelect.appendChild(option);
    });
}

// 스케줄 제출
function submitTask() {
    const form = document.getElementById('addTaskForm');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const formData = new FormData(form);
    
    // fix_dates가 비어있으면 필드 제거
    const fixDates = document.getElementById('fixDates').value.trim();
    if (!fixDates) {
        formData.delete('fixDates');
    }
    
    // taskId 유무에 따라 등록/수정 분기
    const taskId = document.getElementById('taskId').value;
    const url = taskId ? '/tasks/task_update' : '/tasks/task_insert';
    
    fetch(url, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 모달 닫기
            bootstrap.Modal.getInstance(document.getElementById('addTaskModal')).hide();
            
            // 성공 메시지 표시
            alert(data.message);
            
            // 페이지 새로고침
            location.reload();
        } else {
            alert('작업 등록에 실패했습니다.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('작업 등록 중 오류가 발생했습니다.');
    });
}

// 요일 값 계산
function getDaysOfWeekValue() {
    const checkboxes = document.querySelectorAll('input[name="daysOfWeek"]:checked');
    const values = [];
    
    checkboxes.forEach(checkbox => {
        values.push(checkbox.value);
    });
    
    // fix_dates가 있으면 월별 스케줄이므로 days_of_week는 '0'
    const fixDates = document.getElementById('fixDates').value.trim();
    if (fixDates) {
        return '0';
    }
    
    // 모든 요일이 선택되었으면 '1,2,3,4,5,6,7' (매일)
    if (values.length === 7) {
        return '1,2,3,4,5,6,7';
    }
    
    // 콤마로 구분된 문자열 반환
    return values.join(',');
}

// fix_dates 값 계산
function getFixDatesValue() {
    const fixDates = document.getElementById('fixDates').value.trim();
    
    // fix_dates가 비어있으면 null 반환
    if (!fixDates) {
        return null;
    }
    
    return fixDates;
}

// 스케줄 변경 모달 열기
function editTaskModal(task) {
    // 폼 초기화
    document.getElementById('addTaskForm').reset();
    
    // 작업자 목록 로드
    loadUsers();
    
    // 기존 데이터 채우기
    document.getElementById('taskId').value = task.task_id || '';
    document.getElementById('clientId').value = task.client_id || '';
    
    // 작업자 선택 (loadUsers 후 비동기로 설정)
    setTimeout(() => {
        document.getElementById('userId').value = task.user_id || '';
    }, 100);
    
    // 요일 체크박스 설정 (원본 숫자 데이터 사용)
    if (task.days_of_week && task.days_of_week !== '0') {
        const days = task.days_of_week.split(',');
        days.forEach(day => {
            const checkbox = document.getElementById('day' + day.trim());
            if (checkbox) checkbox.checked = true;
        });
    }
    
    // 고정 날짜
    if (task.fix_dates) {
        document.getElementById('fixDates').value = task.fix_dates;
    }
    
    // 시작일/종료일 (flatpickr API 사용)
    const startEl = document.getElementById('serviceStartedAt');
    if (startEl._flatpickr) {
        startEl._flatpickr.setDate(task.service_started_date || '', true);
    } else {
        startEl.value = task.service_started_date || '';
    }
    const endEl = document.getElementById('serviceEndedAt');
    if (endEl._flatpickr) {
        endEl._flatpickr.setDate(task.service_ended_date || '', true);
    } else {
        endEl.value = task.service_ended_date || '';
    }
    
    // 사용 여부
    if (task.use_yn !== undefined) {
        document.getElementById('useYn').checked = !!task.use_yn;
    }
    
    // 수정 모드 설정
    document.getElementById('addTaskModalLabel').innerHTML = 
        '{% if task_kind_id == 4 %}청소{% elif task_kind_id == 5 %}간식{% elif task_kind_id == 6 %}비품{% endif %} 작업 수정';
    const submitBtn = document.getElementById('taskSubmitBtn');
    submitBtn.textContent = '수정';
    submitBtn.className = 'btn btn-success';
    
    const modal = new bootstrap.Modal(document.getElementById('addTaskModal'));
    modal.show();
}

// 작업 삭제 - 모달 표시
function showDeleteTaskModal(button) {
    const taskId = button.dataset.taskId;
    const clientName = button.dataset.clientName;
    
    document.getElementById('deleteTaskId').value = taskId;
    document.getElementById('deleteTaskClientName').textContent = clientName;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteTaskModal'));
    modal.show();
}

// 작업 삭제 - 확인
function confirmDeleteTask() {
    const taskId = document.getElementById('deleteTaskId').value;
    
    const formData = new FormData();
    formData.append('taskId', taskId);
    
    fetch('/tasks/task_delete', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteTaskModal'));
        modal.hide();
        
        if (data.success) {
            showToast('success', data.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('danger', '삭제에 실패했습니다.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteTaskModal'));
        modal.hide();
        showToast('danger', '삭제 중 오류가 발생했습니다.');
    });
}

// 스케줄 생성
function generateSchedule(month, scope) {
    const now = new Date();
    let year, mon;
    if (month === 'current') {
        year = now.getFullYear();
        mon = now.getMonth() + 1;
    } else {
        const next = new Date(now.getFullYear(), now.getMonth() + 1, 1);
        year = next.getFullYear();
        mon = next.getMonth() + 1;
    }
    const yearMonth = year + '-' + String(mon).padStart(2, '0');
    const monthLabel = month === 'current' ? '당월' : '익월';
    
    let taskIds = [];
    if (scope === 'all') {
        document.querySelectorAll('.users-table tbody tr[data-task-id]').forEach(row => {
            taskIds.push(row.dataset.taskId);
        });
    } else {
        document.querySelectorAll('.users-table tbody .row-check:checked').forEach(cb => {
            taskIds.push(cb.value);
        });
        if (taskIds.length === 0) {
            showToast('warning', '스케줄을 생성할 작업을 선택해주세요.');
            return;
        }
    }
    
    if (taskIds.length === 0) {
        showToast('warning', '생성할 작업이 없습니다.');
        return;
    }
    
    const scopeLabel = scope === 'all' ? '전체' : '선택(' + taskIds.length + '건)';
    document.getElementById('generateScheduleMessage').innerHTML = 
        '<strong>' + monthLabel + ' ' + scopeLabel + '</strong> 스케줄을 생성하시겠습니까?<br><span class="small text-muted">' + yearMonth + ' / ' + taskIds.length + '개 작업</span>';
    
    const confirmBtn = document.getElementById('confirmGenerateBtn');
    confirmBtn.onclick = function() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('generateScheduleModal'));
        modal.hide();
        
        const formData = new FormData();
        taskIds.forEach(id => formData.append('taskIds[]', id));
        formData.append('yearMonth', yearMonth);
        
        fetch('/tasks/task_schedule_generate', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json().then(data => ({ok: response.ok, data})))
        .then(({ok, data}) => {
            if (ok && data.success) {
                showToast('success', data.message);
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('danger', data.message || '스케줄 생성에 실패했습니다.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('danger', '스케줄 생성 중 오류가 발생했습니다.');
        });
    };
    
    const modal = new bootstrap.Modal(document.getElementById('generateScheduleModal'));
    modal.show();
}

// Toast 알림 함수
function showToast(type, message) {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    const toastId = 'toast-' + Date.now();
    
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1050';
    document.body.appendChild(container);
    return container;
}

</script>
{% endblock %}
