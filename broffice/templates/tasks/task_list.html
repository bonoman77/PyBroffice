{% extends "layout.html" %}
{% from "macros/form.html" import input, textarea %}

{% block title %}
  {% if task_kind_id == 4 %}청소 스케줄
  {% elif task_kind_id == 5 %}간식 스케줄
  {% elif task_kind_id == 6 %}비품 스케줄
  {% else %}업체 목록
  {% endif %}
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <div>
    <h1 class="page-title">
      {% if task_kind_id == 4 %}
       청소 스케줄관리
      {% elif task_kind_id == 5 %}
       간식 스케줄관리
      {% elif task_kind_id == 6 %}
       비품 스케줄관리
      {% else %}
       업체 목록
      {% endif %}
    </h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">홈</a></li>
        <li class="breadcrumb-item">
          {% if task_kind_id == 4 %}청소
          {% elif task_kind_id == 5 %}간식
          {% elif task_kind_id == 6 %}비품
          {% else %}업무
          {% endif %}
        </li>
        <li class="breadcrumb-item active">스케줄등록</li>
      </ol>
    </nav>
  </div>
</div>

<!-- Client Stats Strip -->
<div class="users-stats">
  <div class="users-stat-card">
    <div class="users-stat-icon primary"><i class="ph-duotone ph-buildings"></i></div>
    <div class="users-stat-body">
      <div class="users-stat-value">{{ total_clients|default(0) }}</div>
      <div class="users-stat-label">전체업체</div>
    </div>
  </div>
  <div class="users-stat-card">
    <div class="users-stat-icon success"><i class="ph-duotone ph-calendar-plus"></i></div>
    <div class="users-stat-body">
      <div class="users-stat-value">{{ schedule_registered|default(0) }}</div>
      <div class="users-stat-label">확정 스케줄수</div>
    </div>
  </div>
  <div class="users-stat-card">
    <div class="users-stat-icon warning"><i class="ph-duotone ph-map-pin"></i></div>
    <div class="users-stat-body">
      <div class="users-stat-value">{{ area_registered|default(0) }}</div>
      <div class="users-stat-label">확정 구역수</div>
    </div>
  </div>
</div>

<!-- Clients Table Card -->
<div class="card">
  <div class="users-toolbar">
    <div class="users-toolbar-left">
      <div class="users-search">
        <i class="ph ph-magnifying-glass"></i>
        <input type="text" placeholder="업체 검색..." id="clientSearch">
      </div>
      <div class="users-filter-group">
        <div class="dropdown">
          <button class="users-filter-btn" data-bs-toggle="dropdown">
            <i class="ph ph-circle-half"></i> 상태
            <i class="ph ph-caret-down"></i>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item active" href="#" data-filter="status" data-value="all">전체 상태</a></li>
            <li><a class="dropdown-item" href="#" data-filter="status" data-value="active">활성</a></li>
            <li><a class="dropdown-item" href="#" data-filter="status" data-value="pending">검토중</a></li>
            <li><a class="dropdown-item" href="#" data-filter="status" data-value="inactive">비활성</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="users-toolbar-right">
      <button class="btn btn-primary" onclick="openScheduleModal()">
        <i class="ph ph-calendar-plus me-2"></i>스케줄 추가
      </button>
    </div>
  </div>

  <div class="users-table-wrap">
    <table class="users-table">
      <thead>
        <tr>
          <th class="users-th-check">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="selectAll">
            </div>
          </th>
          <th>업체명</th>
          <th>작업자</th>
          <th>스케줄</th>
          <th>구역수</th>
          <th>등록일</th>
          <th class="users-th-actions">작업</th>
        </tr>
      </thead>
      <tbody>
        {% if schedules %}
          {% for schedule in schedules %}
          <tr>
            <td>
              <div class="form-check"><input class="form-check-input" type="checkbox"></div>
            </td>
            <td>
              <div class="users-cell-user">
               <div>
                  <a href="#" class="users-cell-name">{{ schedule.client_name }}</a>
                </div>
              </div>
            </td>
            <td class="users-cell-meta">
              <div>{{ schedule.user_name }}</div>
              <div class="users-cell-email">{{ schedule.user_mobile }}</div>
            </td>
            <td class="users-cell-meta">
              <div>{{ schedule.day_of_week }}</div>
            </td>
            <td class="users-cell-meta">
              <div>-</div>
            </td>
            <td class="users-cell-meta">
              <div>{{ schedule.created_at.strftime('%Y-%m-%d') if schedule.created_at else '-' }}</div>
            </td>
            <td>
              <div class="table-actions justify-content-end">
                <button class="btn btn-icon btn-sm btn-light" title="스케줄등록" onclick="addScheduleModal({{ schedule.task_id }}, '{{ schedule|tojson|safe }}')"><i class="ph ph-calendar-plus"></i></button>
                <button class="btn btn-icon btn-sm btn-light" title="구역등록" onclick="addArea({{ schedule.task_id }}, '{{ schedule|tojson|safe }}')"><i class="ph ph-map-pin"></i></button>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="9" class="text-center py-5">
              <div class="text-muted">
                <i class="ph 
                  {% if task_kind_id == 4 %}ph-broom
                  {% elif task_kind_id == 5 %}ph-hamburger
                  {% elif task_kind_id == 6 %}ph-package
                  {% else %}ph-buildings
                  {% endif %}" style="font-size: 48px; opacity: 0.3;"></i>
                <p class="mt-3 mb-0">등록된 업체가 없습니다.</p>
              </div>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="users-pagination" id="schedulesPagination" style="display: none;">
    <div class="users-pagination-info" id="paginationInfo">
      Showing <strong id="showingRange">1-10</strong> of <strong id="totalCount">0</strong> schedules
    </div>
    <nav>
      <ul class="pagination mb-0" id="paginationList">
        <!-- 페이지 버튼이 동적으로 생성됩니다 -->
      </ul>
    </nav>
  </div>
</div>

<!-- Add Schedule Modal -->
<div class="modal fade" id="addScheduleModal" tabindex="-1" aria-labelledby="addScheduleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addScheduleModalLabel">
          {% if task_kind_id == 4 %}청소
          {% elif task_kind_id == 5 %}간식
          {% elif task_kind_id == 6 %}비품
          {% endif %} 스케줄 등록
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addScheduleForm">
          <input type="hidden" id="taskKindId" name="taskKindId" value="{{ task_kind_id }}">
          <input type="hidden" id="scheduleId" name="scheduleId">
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="clientId" class="form-label">업체 <span class="text-danger">*</span></label>
              <select class="form-select" id="clientId" name="clientId" required>
                <option value="">업체 선택</option>
                {% for client in clients %}
                <option value="{{ client.client_id }}">{{ client.client_name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="userId" class="form-label">작업자 <span class="text-danger">*</span></label>
              <select class="form-select" id="userId" name="userId" required>
                <option value="">작업자 선택</option>
              </select>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="daysOfWeek" class="form-label">요일</label>
              <div class="d-flex gap-2">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day1" name="daysOfWeek" value="1">
                  <label class="form-check-label" for="day1">월</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day2" name="daysOfWeek" value="2">
                  <label class="form-check-label" for="day2">화</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day3" name="daysOfWeek" value="3">
                  <label class="form-check-label" for="day3">수</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day4" name="daysOfWeek" value="4">
                  <label class="form-check-label" for="day4">목</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day5" name="daysOfWeek" value="5">
                  <label class="form-check-label" for="day5">금</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day6" name="daysOfWeek" value="6">
                  <label class="form-check-label" for="day6">토</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="day7" name="daysOfWeek" value="7">
                  <label class="form-check-label" for="day7">일</label>
                </div>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="fixDates" class="form-label">월별 고정 날짜 (선택사항)</label>
              <input type="text" class="form-control" id="fixDates" name="fixDates" placeholder="예: 15, 25 (콤마로 구분)">
              <div class="form-text">월별 스케줄일 경우 날짜를 입력하세요. 여러 날짜는 콤마로 구분합니다.</div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="serviceStartedAt" class="form-label">관리 시작일 <span class="text-danger">*</span></label>
              {{ input('date', 'serviceStartedAt', '', opt='required') }}
            </div>
            <div class="col-md-6 mb-3">
              <label for="serviceEndedAt" class="form-label">관리 종료일</label>
              {{ input('date', 'serviceEndedAt', '') }}
            </div>
          </div>
          
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="useYn" name="useYn" checked>
              <label class="form-check-label" for="useYn">
                사용
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" onclick="submitSchedule()">등록</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// 클라이언트 관리 JavaScript
let currentClients = [];

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    loadClients();
    setupEventListeners();
});

// 페이징 초기화 (임시 비활성화)
function initializePagination() {
    // TODO: 페이징 기능 나중에 구현
    console.log('페이징 기능 준비중...');
}

// 이벤트 리스너 설정
function setupEventListeners() {
    // 검색
    document.getElementById('clientSearch').addEventListener('input', function(e) {
        filterClients(e.target.value);
    });
    
    // 상태 필터
    document.querySelectorAll('[data-filter="status"]').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            filterByStatus(this.dataset.value);
            
            // 활성 상태 업데이트
            document.querySelectorAll('[data-filter="status"]').forEach(el => {
                el.classList.remove('active');
            });
            this.classList.add('active');
        });
    });
}

// 클라이언트 데이터 로드
function loadClients() {
    // 실제로는 서버에서 데이터를 가져와야 함
    // 여기서는 예시 데이터 사용
    currentClients = [
        {
            client_id: 1,
            client_name: '테스트 업체',
            client_business_number: '123-45-67890',
            staff_name: '홍길동',
            schedule_count: 5,
            area_count: 3,
            created_at: '2024-01-15'
        }
    ];
}

// 검색 필터
function filterClients(searchTerm) {
    const filtered = currentClients.filter(client => 
        client.client_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        client.client_business_number.includes(searchTerm)
    );
    renderClients(filtered);
}

// 상태 필터
function filterByStatus(status) {
    // 상태별 필터링 로직
    renderClients(currentClients);
}

// 클라이언트 목록 렌더링
function renderClients(clients) {
    // 실제 렌더링 로직
}

// 스케줄 모달 열기
function openScheduleModal() {
    const modal = new bootstrap.Modal(document.getElementById('addScheduleModal'));
    
    // 폼 초기화
    document.getElementById('addScheduleForm').reset();
    document.getElementById('scheduleId').value = '';
    
    // 작업자 목록 로드
    loadUsers();
    
    modal.show();
}

// 사용자 목록 로드
function loadUsers() {
    const userSelect = document.getElementById('userId');
    userSelect.innerHTML = '<option value="">작업자 선택</option>';
    
    // 서버에서 작업자 목록 가져오기
    const workersData = {{ workers|tojson|safe }};
    
    workersData.forEach(worker => {
        const option = document.createElement('option');
        option.value = worker.user_id;
        option.textContent = worker.user_name;
        userSelect.appendChild(option);
    });
}

// 스케줄 제출
function submitSchedule() {
    const form = document.getElementById('addScheduleForm');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const formData = new FormData(form);
    
    // fix_dates가 비어있으면 필드 제거
    const fixDates = document.getElementById('fixDates').value.trim();
    if (!fixDates) {
        formData.delete('fixDates');
    }
    
    // 서버에 스케줄 데이터 전송
    fetch('/tasks/schedule_insert', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 모달 닫기
            bootstrap.Modal.getInstance(document.getElementById('addScheduleModal')).hide();
            
            // 성공 메시지 표시
            alert(data.message);
            
            // 페이지 새로고침
            location.reload();
        } else {
            alert('스케줄 등록에 실패했습니다.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('스케줄 등록 중 오류가 발생했습니다.');
    });
}

// 요일 값 계산
function getDaysOfWeekValue() {
    const checkboxes = document.querySelectorAll('input[name="daysOfWeek"]:checked');
    const values = [];
    
    checkboxes.forEach(checkbox => {
        values.push(checkbox.value);
    });
    
    // fix_dates가 있으면 월별 스케줄이므로 days_of_week는 '0'
    const fixDates = document.getElementById('fixDates').value.trim();
    if (fixDates) {
        return '0';
    }
    
    // 모든 요일이 선택되었으면 '1,2,3,4,5,6,7' (매일)
    if (values.length === 7) {
        return '1,2,3,4,5,6,7';
    }
    
    // 콤마로 구분된 문자열 반환
    return values.join(',');
}

// fix_dates 값 계산
function getFixDatesValue() {
    const fixDates = document.getElementById('fixDates').value.trim();
    
    // fix_dates가 비어있으면 null 반환
    if (!fixDates) {
        return null;
    }
    
    return fixDates;
}

// 스케줄 등록
function addSchedule(clientId, clientData) {
    console.log('스케줄 등록:', clientId, clientData);
}

// 구역 등록
function addArea(clientId, clientData) {
    console.log('구역 등록:', clientId, clientData);
}
</script>
{% endblock %}
